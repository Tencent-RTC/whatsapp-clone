"use strict";const e=2,t=4,s=10,o=11,r=12,i=14,n=20,a=23,u=26,p=27,l=29,c=30,h=34;class g{constructor(e=0,t=0){this.high=e,this.low=t}equal(e){return null!==e&&this.low===e.low&&this.high===e.high}toString(){var e=Number(this.high).toString(16);let t=Number(this.low).toString(16);if(t.length<8){let e=8-t.length;for(;e;)t="0"+t,e--}return e+t}}const m={TEST:{CHINA:{DEFAULT:"wss://wss-dev.tim.qq.com"},OVERSEA:{DEFAULT:"wss://wss-dev.tim.qq.com"},SINGAPORE:{DEFAULT:"wss://wsssgp-dev.im.qcloud.com"},KOREA:{DEFAULT:"wss://wsskr-dev.im.qcloud.com"},GERMANY:{DEFAULT:"wss://wssger-dev.im.qcloud.com"},IND:{DEFAULT:"wss://wssind-dev.im.qcloud.com"},JPN:{DEFAULT:"wss://wssjpn-dev.im.qcloud.com"},USA:{DEFAULT:"wss://wssusa-dev.im.qcloud.com"},INDONESIA:{DEFAULT:"wss://wssidn-dev.im.qcloud.com"}},PRODUCTION:{CHINA:{DEFAULT:"wss://wss.im.qcloud.com",BACKUP:"wss://wss.tim.qq.com",STAT:"https://events.im.qcloud.com",ANYCAST:"wss://162.14.13.203"},OVERSEA:{DEFAULT:"wss://wss.im.qcloud.com",BACKUP:"wss://wss.my-imcloud.com",STAT:"https://api.my-imcloud.com"},SINGAPORE:{DEFAULT:"wss://wsssgp.im.qcloud.com",BACKUP:"wss://wsssgp.my-imcloud.com",STAT:"https://apisgp.my-imcloud.com",ANYCAST:"wss://162.14.19.159"},KOREA:{DEFAULT:"wss://wsskr.im.qcloud.com",BACKUP:"wss://wsskr.my-imcloud.com",STAT:"https://apikr.my-imcloud.com",ANYCAST:"wss://162.14.13.104"},GERMANY:{DEFAULT:"wss://wssger.im.qcloud.com",BACKUP:"wss://wssger.my-imcloud.com",STAT:"https://apiger.my-imcloud.com",ANYCAST:"wss://162.14.3.17"},IND:{DEFAULT:"wss://wssind.my-imcloud.com",BACKUP:"wss://wssind.im.qcloud.com",STAT:"https://apiind.my-imcloud.com",ANYCAST:"wss://162.14.18.188"},JPN:{DEFAULT:"wss://wssjpn.im.qcloud.com",BACKUP:"wss://wssjpn.my-imcloud.com",STAT:"https://apijpn.my-imcloud.com"},USA:{DEFAULT:"wss://wssusa.im.qcloud.com",BACKUP:"wss://wssusa.my-imcloud.com",STAT:"https://apiusa.my-imcloud.com",ANYCAST:"wss://162.14.10.42"},INDONESIA:{DEFAULT:"wss://wssidn.im.qcloud.com",BACKUP:"wss://wssidn.my-imcloud.com",STAT:"https://apiidn.my-imcloud.com",ANYCAST:"wss://43.129.34.169"}}},d={ANDROID:2,IOS:3,MAC:4,WEB:7,WX_MP:8,QQ_MP:9,TT_MP:10,BAIDU_MP:11,ALI_MP:12,IPAD:13,UNI_NATIVE_APP:15,DONUT_NATIVE_APP:19},_="CHINA",f={HOST:{CURRENT:{DEFAULT:"wss://wss.im.qcloud.com",STAT:"https://events.im.qcloud.com"},setCurrent(e=_){this.CURRENT=m.PRODUCTION[e]}},NAME:{OPEN_IM:"openim",OPEN_IM_MSG_EXT:"openim_msg_ext_http_svc",GRP:"group_open_http_svc",GRP_AV:"group_open_avchatroom_http_svc",GRP_COMMUNITY:"million_group_open_http_svc",GRP_ATTR:"group_open_attr_http_svc",FD:"sns",PROFILE:"profile",RECENT_CONTACT:"recentcontact",PIC:"openpic",BIG_GRP_NO_AUTH:"group_open_http_noauth_svc",BIG_GRP_POLLING:"group_open_long_polling_http_svc",BIG_GRP_POLLING_NO_AUTH:"group_open_long_polling_http_noauth_svc",IM_OPEN_STAT:"imopenstat",WEB_IM:"webim",IM_COS_SIGN:"im_cos_sign_svr",CUSTOM_UPLOAD:"im_cos_msg",HEARTBEAT:"heartbeat",IM_OPEN_PUSH:"im_open_push",IM_OPEN_STATUS:"im_open_status",IM_LONG_MSG:"im_long_msg",IM_CONFIG_MANAGER:"im_sdk_config_mgr",STAT_SERVICE:"StatSvc",OVERLOAD_PUSH:"OverLoadPush",IM_MSG_AUDIT_MGR:"im_msg_audit_mgr",TUIROOM_SVR:"tui_room_svr",IM_OPEN_TRANSLATE:"im_open_translate",IM_OPEN_SPEECH:"im_open_speech",MSG_SEARCH:"message_search",FOLLOW:"follow",OFFLINE_PUSH_REPORT:"offline_push_report",IM_MSG_LOGIC:"im_msg_db_logic"}},M={SEARCH_GRP_SNS:new g(0,Math.pow(2,1)).toString(),AV_HISTORY_MSG:new g(0,Math.pow(2,2)).toString(),GRP_COMMUNITY:new g(0,Math.pow(2,3)).toString(),MSG_TO_SPECIFIED_GRP_MBR:new g(0,Math.pow(2,4)).toString(),AV_MBR_LIST:new g(0,Math.pow(2,6)).toString(),USER_STATUS:new g(0,Math.pow(2,7)).toString(),CONV_MARK:new g(0,Math.pow(2,9)).toString(),CONV_GROUP:new g(0,Math.pow(2,10)).toString(),AV_BAN_MBR:new g(0,Math.pow(2,11)).toString(),MSG_EXT:new g(0,Math.pow(2,13)).toString(),GRP_COUNTER:new g(0,Math.pow(2,15)).toString(),PLUGIN_TRANSLATE:new g(Math.pow(2,6)).toString(),PLUGIN_VOICE_TO_TEXT:new g(Math.pow(2,7)).toString(),PLUGIN_CS:new g(Math.pow(2,8)).toString(),PLUGIN_PUSH:new g(Math.pow(2,9)).toString(),PLUGIN_BOT:new g(Math.pow(2,10)).toString(),MSG_REACTION:new g(Math.pow(2,16)).toString(),FOLLOW:new g(Math.pow(2,20)).toString()},I="group_profile",D="group_member_profile",L=["Type","Name","Introduction","Notification","FaceUrl","Owner_Account","CreateTime","InfoSeq","LastInfoTime","LastMsgTime","MemberNum","MaxMemberNum","ApplyJoinOption","NextMsgSeq","ShutUpAllMember","InviteJoinOption"],y=["Role","JoinTime","MsgSeq","MsgFlag"],G=(f.HOST.setCurrent(_),"undefined"!=typeof wx&&"function"==typeof wx.getSystemInfoSync&&Boolean(wx.getSystemInfoSync().fontSizeSetting)),C=(G&&wx.createGamePortal,"undefined"!=typeof qq&&"function"==typeof qq.getSystemInfoSync&&Boolean(qq.getSystemInfoSync().fontSizeSetting)),b="undefined"!=typeof tt&&"function"==typeof tt.getSystemInfoSync&&Boolean(tt.getSystemInfoSync().fontSizeSetting),T="undefined"!=typeof swan&&"function"==typeof swan.getSystemInfoSync&&Boolean(swan.getSystemInfoSync().fontSizeSetting),A="undefined"!=typeof my&&"function"==typeof my.getSystemInfoSync&&Boolean(my.getSystemInfoSync().fontSizeSetting),v="undefined"!=typeof jd&&"function"==typeof jd.getSystemInfoSync,S="undefined"!=typeof uni&&"undefined"==typeof window&&"function"==typeof uni.requireNativePlugin,P=G&&"object"==typeof wx.miniapp,R=G||C||b||T||A||S||v,$=("undefined"!=typeof uni||"undefined"!=typeof window)&&!R,E=(C?qq:b?tt:T?swan:A?my:G?wx:S?uni:v&&jd,$&&window&&window.navigator&&window.navigator.userAgent||""),w=/(micromessenger|webbrowser)/i.test(E),U=/AppleWebKit\/([\d.]+)/i.exec(E),N=(U&&parseFloat(U.pop()),function(){let e="WEB";return w?e="WEB":C?e="QQ_MP":b?e="TT_MP":T?e="BAIDU_MP":A?e="ALI_MP":G?e=P?"DONUT_NATIVE_APP":"WX_MP":S&&(e="UNI_NATIVE_APP"),d[e]}()),q=(!function(){var e=E.match(/OS (\d+)_/i);e&&e[1]&&e[1]}(),function(){var e,t,s=E.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);s&&(e=s[1]&&parseFloat(s[1]),t=s[2]&&parseFloat(s[2]),e&&t&&parseFloat(s[1]+"."+s[2]))}(),function(){var e=E.match(/Chrome\/(\d+)/);e&&e[1]&&parseFloat(e[1])}(),/MSIE/.test(E)||-1<E.indexOf("Trident")&&-1<E.indexOf("rv:11.0"));let k,O;!function(){var e=/MSIE\s(\d+)\.\d/.exec(E),e=e&&parseFloat(e[1]);!e&&/Trident\/7.0/i.test(E)&&/rv:11.0/.test(E)}(),function(){var e=E.match(/TBS\/(\d+)/i);e&&e[1]&&e[1]}(),k="undefined"!=typeof console?console:"undefined"!=typeof global&&global.console?global.console:"undefined"!=typeof window&&window.console?window.console:{};const F=function(){},x=["assert","clear","count","debug","dir","dirxml","error","group","groupCollapsed","groupEnd","info","log","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"];let V=x.length;for(;V--;)O=x[V],console[O]||(k[O]=F);var H=k;const j="TIMTextElem",B="TIMImageElem",K="TIMSoundElem",J="TIMFileElem",W="TIMFaceElem",z="TIMVideoFileElem",X="TIMLocationElem",Y="TIMGroupTipElem",Q="TIMGroupSystemNoticeElem",Z="TIMCustomElem",ee="TIMRelayElem",te="High",se="Normal",oe="Low",re="Lowest",ie="C2C",ne="GROUP",ae="TOPIC",ue="@TIM#SYSTEM",pe="Private",le="Public",ce="ChatRoom",he="AVChatRoom",ge="Community",me="Room",de="Live",_e="Owner",fe="Admin",Me="Member",Ie="Custom",De=1,Le=3,ye=4,Ge=5,Ce="AcceptAndNotify",be="AlreadyInGroup",Te="__kImSDK_MesssageAtALL__",Ae=function(){return(new Date).getTime()+0},ve={JPG:1,JPEG:1,GIF:2,PNG:3,BMP:4,UNKNOWN:255},Se={NICK:"Tag_Profile_IM_Nick",GENDER:"Tag_Profile_IM_Gender",BIRTHDAY:"Tag_Profile_IM_BirthDay",LOCATION:"Tag_Profile_IM_Location",SELFSIGNATURE:"Tag_Profile_IM_SelfSignature",ALLOWTYPE:"Tag_Profile_IM_AllowType",LANGUAGE:"Tag_Profile_IM_Language",AVATAR:"Tag_Profile_IM_Image",MESSAGESETTINGS:"Tag_Profile_IM_MsgSettings",ADMINFORBIDTYPE:"Tag_Profile_IM_AdminForbidType",LEVEL:"Tag_Profile_IM_Level",ROLE:"Tag_Profile_IM_Role"},Pe="JoinedSuccess",Re="WaitAdminApproval",$e="@TGS#_",Ee="@TOPIC#_",we=Object.prototype.hasOwnProperty;function Ue(e){if(null==e)return!0;if("boolean"==typeof e)return!1;if("number"==typeof e)return 0===e;if("string"==typeof e)return 0===e.length;if("function"==typeof e)return 0===e.length;if(Array.isArray(e))return 0===e.length;if(e instanceof Error)return""===e.message;if(xe(e)){for(const t in e)if(we.call(e,t))return!1;return!0}return!!(Ne(e)||qe(e)||ke(e))&&0===e.size}const Ne=function(e){return"map"===Be(e)},qe=function(e){return"set"===Be(e)},ke=function(e){return"file"===Be(e)},Oe=function(e){return null!==e&&("number"==typeof e&&!isNaN(+e)||"object"==typeof e&&e.constructor===Number)},Fe=function(e){return"string"==typeof e},xe=function(e){if("object"!=typeof e||null===e)return!1;e=Object.getPrototypeOf(e);if(null===e)return!0;let t=e;for(;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return e===t},Ve=function(e){return"function"==typeof Array.isArray?Array.isArray(e):"array"===Be(e)},He=function(e){return void 0===e},je=function(e){return Ve(e)||null!==e&&"object"==typeof e},Be=function(e){return Object.prototype.toString.call(e).match(/^\[object (.*)\]$/)[1].toLowerCase()},Ke=(Date.now||(Date.now=function(){return(new Date).getTime()}),function(s,o,r,i){if(!je(s)||!je(o))return 0;let n=0;var a,u=Object.keys(o);for(let e=0,t=u.length;e<t;e++)if(a=u[e],!(He(o[a])||r&&r.includes(a)))if(je(s[a])&&je(o[a]))n+=Ke(s[a],o[a],r,i);else{if(i&&i.includes(o[a]))continue;s[a]!==o[a]&&(s[a]=o[a],n+=1)}return n}),Je=function(e){e=e||99999999;return Math.round(Math.random()*e)},We={},ze=function(e){if(0===Object.getOwnPropertyNames(e).length)return Object.create(null);const t=Array.isArray(e)?[]:Object.create(null);var s;for(const o in e)null!==e[o]?void 0!==e[o]?(s=typeof e[o],0<=["string","number","function","boolean"].indexOf(s)?t[o]=e[o]:t[o]=ze(e[o])):t[o]=void 0:t[o]=null;return t};function Xe(o,e){if(!Ve(o)||!Ve(e))return!1;let r=!1;return e.forEach(({key:t,value:e})=>{const s=o.find(e=>e.key===t);s?s.value!==e&&(s.value=e,r=!0):(o.push({key:t,value:e}),r=!0)}),r}function Ye(e){return Ue(e)?[]:e.filter(e=>!0===e.isModified)}function Qe(e){return Ue(e)?[]:e.filter(e=>!1===e.isModified)}const Ze=e=>e===he,et=({type:e,groupID:t})=>e===ge||(""+t).startsWith($e)&&!(""+t).includes(Ee),st=e=>(""+e).startsWith($e)&&(""+e).includes(Ee);function ot(e){return e.split(Ee)[0]}function rt(){return!q&&!R}function it(t,s){if(t){let e=t;return s&&(t.startsWith("http://")?e=t.replace(/^http:\/\/[^/]+/,s):t.startsWith("https://")&&(e=t.replace(/^https:\/\/[^/]+/,s))),e}}function nt(e,t=!0,s=!0){var o=Date.now();return t?s?o-e+" ms":Math.round((o-e)/1e3)+" s":s?o-e:Math.round((o-e)/1e3)}let at=0;function ut(){return rt()?"%c Chat %c":"Chat"}function pt(){const e=function(){const e=new Date;return e.setTime(Ae()),e}();return e.toLocaleTimeString("en-US",{hour12:!1})+"."+function(e){let t;switch(e.toString().length){case 1:t="00"+e;break;case 2:t="0"+e;break;default:t=e}return t}(e.getMilliseconds())}const lt={arguments2String(s){let o="";if(1===s.length)o=s[0];else for(let e=0,t=s.length;e<t;e++)je(s[e])?s[e]instanceof Error?o+=(r=s[e],JSON.stringify(r,["message","code"])):o+=JSON.stringify(s[e]):o+=s[e],o+=" ";var r;return o},_exec(e,t){rt()?H[e](ut(),"background:#0abf5b; padding:1px; border-radius:3px; color: #fff","background:transparent",pt(),t):H[e](`${ut()} ${pt()} `+t)},d:function(){var e;at<=-1&&(e=this.arguments2String(arguments),this._exec("debug",e))},l:function(){var e;at<=0&&(e=this.arguments2String(arguments),this._exec("log",e))},log:function(){var e;at<=0&&(e=this.arguments2String(arguments),this._exec("log",e))},i:function(){var e;at<=1&&(e=this.arguments2String(arguments),this._exec("info",e))},w:function(){var e;at<=2&&(e=this.arguments2String(arguments),this._exec("warn",e))},e:function(){var e;at<=3&&(e=this.arguments2String(arguments),this._exec("error",e))},setLevel:function(e){e<4&&this._exec("log","set level from "+at+" to "+e),at=e},getLevel:function(){return at}},ct=function(e){return{code:0,data:e||{}}};class ht extends Error{constructor(e){super();var{code:e,message:t,data:s}=e;this.code=e,t?this.message=t:this._getErrMsg&&(this.message=this._getErrMsg(this.code)),this.data=s||{}}}const gt=2101,mt=2114,dt=2600,_t=2601,ft=2602,Mt=2603,It=2620,Dt=2621,Lt=2622,yt=2623,Gt=2660,Ct=2661,bt=2662,Tt=2681,At=2682,vt=2683,St=2684,Pt=2685,Rt=2686,$t=2687,Et=2805,wt=2903,Ut=3122,Nt=3123,qt="onMessageReceived",kt="onMessageModified",Ot="onMessageRevoked",Ft="onGroupListUpdated",xt="groupAttributesUpdated",Vt="onGroupCounterUpdated",Ht="onTopicUpdated",jt="error";let Bt=null;const Kt=function(e){return Promise.resolve(ct(e))},Jt=function(e,t=!1){if(e instanceof ht)return t&&null!==Bt&&Bt.emit(jt,e),Promise.reject(e);if(e instanceof Error){const e=new ht({code:wt});return t&&null!==Bt&&Bt.emit(jt,e),Promise.reject(e)}if(He(e)||He(e.code))return Promise.reject(new ht({code:wt}));e=new ht(e);return t&&null!==Bt&&Bt.emit(jt,e),Promise.reject(e)},Wt={A2KEY_AND_TINYID_UPDATED:"_inner1",CLOUD_CONFIG_UPDATED:"_inner2",PROFILE_UPDATED:"_inner3",CONV_SYNC_COMPLETED:"_inner4",C2C_UNREAD_HANDLE_COMPLETED:"_inner5"},zt="messageReceivedGroup",Xt="messageReceivedGroupAVPush",Yt="messageReceivedGroupAVPull",Qt={info:4,warning:5,error:6},Zt={wifi:1,"2g":2,"3g":3,"4g":4,"5g":5,unknown:6,none:7,online:8},es={login:4,plugin_search:16,plugin_translate:16,plugin_voice_to_text:16,plugin_cs:16,plugin_push:16,plugin_bot:16,plugin_emoji_reaction:16};class ts{constructor(e){this._n="SSOLogData",this.eventType=es[e]||0,this.timestamp=0,this.networkType=8,this.code=0,this.message="",this.moreMessage="",this.extension=e,this.costTime=0,this.duplicate=!1,this.level=4,this.uiPlatform=void 0,this._sentFlag=!1,this._startts=Ae()}static bindEventStatModule(e){ts.prototype._eventStatModule=e}static bindNetMonitorModule(e){ts.prototype._netMonitorModule=e}updateTimeStamp(){this.timestamp=Ae()}start(e){return this._startts=e,this}end(e=!1){if(!this._sentFlag){if(this._netMonitorModule){const e=this._netMonitorModule.getNetworkType();this.setNetworkType(e)}var t=Ae();0===this.costTime&&(this.costTime=t-this._startts),this.setMoreMessage(`startts:${this._startts} endts:`+t),e?(this._sentFlag=!0,this._eventStatModule&&this._eventStatModule.pushIn(this)):setTimeout(()=>{this._sentFlag=!0,this._eventStatModule&&this._eventStatModule.pushIn(this)},0)}}setError(e){if(!(e instanceof Error))return lt.w(this._n+".setError value not instanceof Error, please check!"),this;if(this._sentFlag)return this;let t=!0;if(t=this._netMonitorModule?this._netMonitorModule.isOnline():t)e.code&&this.setCode(e.code),e.message&&this.setMoreMessage(e.message);else{const e=Et;this.setCode(e)}return this.setLevel("error"),this}setCode(e){return He(e)||this._sentFlag||("ECONNABORTED"===e&&(this.code=103),Oe(e)?this.code=e:lt.w(this._n+".setCode value not a number, please check!",e,typeof e)),this}setMessage(e){return He(e)||this._sentFlag||(Oe(e)&&(this.message=e.toString()),Fe(e)&&(this.message=e)),this}setCostTime(e){return this.costTime=e,this}setLevel(e){return He(e)||this._sentFlag||(this.level=Qt[e]),this}setMoreMessage(e){return Ue(this.moreMessage)?this.moreMessage=""+e:this.moreMessage+=" "+e,this}setNetworkType(e){return He(e)?lt.w(this._n+".setNetworkType value is undefined, please check!"):(e=Zt[e.toLowerCase()],He(e)||(this.networkType=e)),this}getStartTs(){return this._startts}setUIPlatform(e){return this.uiPlatform=e,this}setExtension(e){return this.extension=e,this}setEventType(e){return this.eventType=e,this}}const ss="send_group_msg",os="get_joined_group_list",rs="get_group_self_member_info",is="create_group",ns="destroy_group",as="modify_group_base_info",us="apply_join_group",ps="apply_join_group_noauth",ls="quit_group",cs="get_group_public_info",hs="change_group_owner",gs="handle_apply_join_group",ms="handle_invite_join_permission_group",ds="handle_invite_join_group",_s="group_msg_recall",fs="msg_read_report",Ms="group_msg_get",Is="get_group_msg_receipt",Ds="group_msg_receipt",Ls="get_group_msg_receipt_detail",ys="get_pendency",Gs="deletemsg",Cs="get_msg",bs="get_msg_noauth",Ts="get_online_member_num",As="delete_group_ramble_msg_by_seq",vs="modify_group_msg",Ss="set_group_attr",Ps="modify_group_attr",Rs="delete_group_attr",$s="clear_group_attr",Es="get_group_attr",ws="group_set_key_values",Us="group_get_key_values",Ns="batch_get_group_notify",qs="update_group_counter",ks="get_group_counter",Os="get_group_member_info",Fs="get_members",xs="get_specified_group_member_info",Vs="add_group_member",Hs="delete_group_member",js="ban_group_member",Bs="modify_group_member_info",Ks="modify_user_info",Js="unSend",Ws="success",zs="notStart",Xs="resolved",Ys="rejected";class Qs{constructor(e){this.type=j,this.content={text:e.text||""}}setText(e){this.content.text=e}sendable(){return 0!==this.content.text.length}}class Zs{constructor(e,t){this._imageMemoryURL="",this._fileDownloadProxy=t,R?this.createImageDataASURLInWXMiniApp(e.file):this.createImageDataASURLInWeb(e.file),this._initImageInfoModel(),this.type=B,this._percent=0,this.content={imageFormat:e.imageFormat||ve.UNKNOWN,uuid:e.uuid,imageInfoArray:[]},this.initImageInfoArray(e.imageInfoArray),this._autoFixUrl()}_initImageInfoModel(){const t=this;this._ImageInfoModel=function(e){this.instanceID=Je(9999999),this.sizeType=e.type||0,this.type=0,this.size=e.size||0,this.width=e.width||0,this.height=e.height||0,this.imageUrl=e.imageUrl||e.url||"",this.url=it(e.url||t._imageMemoryURL,t._fileDownloadProxy)},this._ImageInfoModel.prototype={setSizeType(e){this.sizeType=e},setType(e){this.type=e},setImageUrl(e){e&&(this.imageUrl=e)},getImageUrl(){return this.imageUrl}}}initImageInfoArray(e){let t=0,s=null,o;for(;t<=2;)o=He(e)||He(e[t])?{type:0,size:0,width:0,height:0,url:""}:e[t],(s=new this._ImageInfoModel(o)).setSizeType(t+1),s.setType(t),this.addImageInfo(s),t++;this.updateAccessSideImageInfoArray()}updateImageInfoArray(t){var s=this.content.imageInfoArray.length;let o;for(let e=0;e<s;e++)o=this.content.imageInfoArray[e],t[e].size&&(o.size=t[e].size),t[e].url&&o.setImageUrl(t[e].url),t[e].width&&(o.width=t[e].width),t[e].height&&(o.height=t[e].height)}_autoFixUrl(){var t=this.content.imageInfoArray.length;let s="",o="";const r=["http","https"];let i=null;for(let e=0;e<t;e++)this.content.imageInfoArray[e].url&&(""!==(i=this.content.imageInfoArray[e]).imageUrl&&(o=i.imageUrl.slice(0,i.imageUrl.indexOf("://")+1),s=i.imageUrl.slice(i.imageUrl.indexOf("://")+1),r.indexOf(o)<0&&(o="https:"),this.content.imageInfoArray[e].setImageUrl([o,s].join(""))))}updatePercent(e){this._percent=e,1<this._percent&&(this._percent=1)}updateImageFormat(e){this.content.imageFormat=ve[e.toUpperCase()]||ve.UNKNOWN}createImageDataASURLInWeb(e){void 0!==e&&0<e.files.length&&(this._imageMemoryURL=window.URL.createObjectURL(e.files[0]))}createImageDataASURLInWXMiniApp(e){e&&e.url&&(this._imageMemoryURL=e.url)}replaceImageInfo(e,t){this.content.imageInfoArray[t]instanceof this._ImageInfoModel||(this.content.imageInfoArray[t]=e)}addImageInfo(e){3<=this.content.imageInfoArray.length||this.content.imageInfoArray.push(e)}updateAccessSideImageInfoArray(){var e=this.content.imageInfoArray,{width:t=0,height:s=0}=e[0];if(0!==t&&0!==s){var o=e,r=o[2];o[2]=o[1],o[1]=r;for(let e=0;e<o.length;e++)o[e].setType(e);Object.assign(e[2],function(e){const{originUrl:t,originWidth:s,originHeight:o,min:r=198}=e,i=parseInt(s),n=parseInt(o),a={url:void 0,width:0,height:0};if((i<=n?i:n)<=r)a.url=t,a.width=i,a.height=n;else{n<=i?(a.width=Math.ceil(i*r/n),a.height=r):(a.width=r,a.height=Math.ceil(n*r/i));const e=t&&-1<t.indexOf("?")?t+"&":t+"?";a.url=198===r?e+"imageView2/3/w/198/h/198":e+"imageView2/3/w/720/h/720"}if(He(t)){const{url:e,...t}=a;return t}return a}({originWidth:t,originHeight:s,min:720}))}}sendable(){return 0!==this.content.imageInfoArray.length&&""!==this.content.imageInfoArray[0].imageUrl&&0!==this.content.imageInfoArray[0].size}}class eo{constructor(e){this.type=W,this.content=e||null}sendable(){return null!==this.content}}class to{constructor(e,t){this.type=K,this._percent=0,this.content={downloadFlag:2,second:e.second,size:e.size,url:it(e.url,t),remoteAudioUrl:e.url||"",uuid:e.uuid}}updatePercent(e){this._percent=e,1<this._percent&&(this._percent=1)}updateAudioUrl(e){this.content.remoteAudioUrl=e}sendable(){return""!==this.content.remoteAudioUrl}}const so={from:!0,groupID:!0,groupName:!0,to:!0};class oo{constructor(e){this.type=Y,this.content={},this._initContent(e)}_initContent(t){Object.keys(t).forEach(e=>{switch(e){case"remarkInfo":break;case"groupProfile":this.content.groupProfile={},this._initGroupProfile(t[e]);break;case"operatorInfo":break;case"memberInfoList":case"msgMemberInfo":this._updateMemberList(t[e]);break;case"memberExtraInfo":case"onlineMemberInfo":break;case"memberNum":this.content[e]=t[e],this.content.memberCount=t[e];break;case"newGroupProfile":this.content.newGroupProfile={},this._initNewGroupProfile(t[e]);break;default:this.content[e]=t[e]}}),this.content.userIDList||(this.content.userIDList=[this.content.operatorID])}_initGroupProfile(t){var s=Object.keys(t);for(let e=0;e<s.length;e++){var o=s[e];so[o]&&(this.content.groupProfile[o]=t[o])}}_updateMemberList(e){Ue(this.content.memberList)?this.content.memberList=e:this.content.memberList.forEach(t=>{e.forEach(e=>{t.userID===e.userID&&Object.assign(t,e)})})}_initNewGroupProfile(t){var s=Object.keys(t);for(let e=0;e<s.length;e++){var o=s[e];this.content.newGroupProfile[o]="muteAllMembers"!==o?t[o]:1===t[o]}}}const ro={from:!0,groupID:!0,groupName:!0,to:!0,groupType:!0};class io{constructor(e){this.type=Q,this.content={},this._initContent(e)}_initContent(t){Object.keys(t).forEach(e=>{switch(e){case"memberInfoList":break;case"remarkInfo":this.content.handleMessage=t[e];break;case"groupProfile":this.content.groupProfile={},this._initGroupProfile(t[e]);break;default:this.content[e]=t[e]}})}_initGroupProfile(t){var s=Object.keys(t);for(let e=0;e<s.length;e++){var o=s[e];ro[o]&&("groupName"===o?this.content.groupProfile.name=t[o]:this.content.groupProfile[o]=t[o])}}}class no{constructor(e,t){this.type=J,this._percent=0;var s=this._getFileInfo(e);this.content={downloadFlag:2,fileUrl:it(e.url||e.fileUrl,t)||"",uuid:e.uuid,fileName:s.name||"",fileSize:s.size||0}}_getFileInfo(e){if(!He(e.fileName)&&!He(e.fileSize))return{size:e.fileSize,name:e.fileName};const t=e.file.files[0];if(S){if(t.path&&-1!==t.path.indexOf(".")){const e=t.path.slice(t.path.lastIndexOf(".")+1).toLowerCase();t.type=e,t.name||(t.name=Je(999999)+"."+e)}t.name||(t.type="",t.name=t.path.slice(t.path.lastIndexOf("/")+1).toLowerCase()),t.suffix&&(t.type=t.suffix),t.url||(t.url=t.path)}return{size:t.size,name:t.name}}updatePercent(e){this._percent=e,1<this._percent&&(this._percent=1)}updateFileUrl(e){this.content.fileUrl=e}sendable(){return""!==this.content.fileUrl&&""!==this.content.fileName&&0!==this.content.fileSize}}class ao{constructor(e){this.type=Z,this.content={data:e.data||"",description:e.description||"",extension:e.extension||""}}setData(e){return this.content.data=e,this}setDescription(e){return this.content.description=e,this}setExtension(e){return this.content.extension=e,this}sendable(){return 0!==this.content.data.length||0!==this.content.description.length||0!==this.content.extension.length}}class uo{constructor(e,t){this.type=z,this._percent=0,this.content={remoteVideoUrl:e.remoteVideoUrl||e.videoUrl||"",videoFormat:e.videoFormat,videoSecond:parseInt(e.videoSecond,10),videoSize:e.videoSize,videoUrl:it(e.videoUrl,t),videoDownloadFlag:2,videoUUID:e.videoUUID,thumbUUID:e.thumbUUID,thumbFormat:e.thumbFormat,thumbWidth:e.thumbWidth,snapshotWidth:e.thumbWidth,thumbHeight:e.thumbHeight,snapshotHeight:e.thumbHeight,thumbSize:e.thumbSize,snapshotSize:e.thumbSize,thumbDownloadFlag:2,thumbUrl:it(e.thumbUrl,t),snapshotUrl:it(e.thumbUrl,t)}}updatePercent(e){this._percent=e,1<this._percent&&(this._percent=1)}updateVideoUrl(e){e&&(this.content.remoteVideoUrl=e)}updateSnapshotInfo(e){var{snapshotUrl:e,snapshotWidth:t,snapshotHeight:s}=e;Ue(e)||(this.content.thumbUrl=this.content.snapshotUrl=e),Ue(t)||(this.content.thumbWidth=this.content.snapshotWidth=Number(t)),Ue(s)||(this.content.thumbHeight=this.content.snapshotHeight=Number(s))}sendable(){return""!==this.content.remoteVideoUrl}}class po{constructor(e){this.type=X;var{description:e,longitude:t,latitude:s}=e;this.content={description:e,longitude:t,latitude:s}}sendable(){return!0}}class lo{constructor(e,t){var s,o;this.from=e.from,this.messageSender=e.from,this.time=e.time,this.messageSequence=e.sequence,this.clientSequence=e.clientSequence||e.sequence,this.messageRandom=e.random,this.cloudCustomData=e.cloudCustomData||"",this.clientTime=e.clientTime||void 0,e.ID?(this.ID=e.ID||"",this.nick=e.nick||"",this.avatar=e.avatar||"",e.messageBody?this.messageBody=JSON.parse(JSON.stringify(e.messageBody)):this.messageBody=[{type:e.type,payload:e.payload}],e.conversationType?e.conversationType.startsWith(ie)?this.receiverUserID=e.to:e.conversationType.startsWith(ne)&&(this.receiverGroupID=e.to):e.receiverGroupID?this.receiverGroupID=e.receiverGroupID:e.receiverUserID&&(this.receiverUserID=e.receiverUserID),this.messageReceiver=e.to||e.messageReceiver):(this.nick=e.nick||"",this.avatar=e.avatar||"",this.messageBody=[],s=e.elements[0].type,o=e.elements[0].content,this._patchRichMediaPayload(s,o),this._updateRichMediaDownloadUrl(s,o,t),s===ee?this.messageBody.push({type:s,payload:new co(o).content}):this.messageBody.push({type:s,payload:o}),e.groupID&&(this.receiverGroupID=e.groupID,this.messageReceiver=e.groupID),e.to&&(this.receiverUserID=e.to,this.messageReceiver=e.to),this.ID=`${e.tinyID}-${e.clientTime}-`+e.random)}_patchRichMediaPayload(e,t){e===B?t.imageInfoArray.forEach(e=>{!e.imageUrl&&e.url&&(e.imageUrl=e.url,e.sizeType=e.type,1===e.type?e.type=0:3===e.type&&(e.type=1))}):e===z?!t.remoteVideoUrl&&t.videoUrl&&(t.remoteVideoUrl=t.videoUrl):e===K?!t.remoteAudioUrl&&t.url&&(t.remoteAudioUrl=t.url):e===J&&!t.fileUrl&&t.url&&(t.fileUrl=t.url,t.url=void 0)}_updateRichMediaDownloadUrl(e,t,s){s&&(e===B?t.imageInfoArray.forEach(e=>{e.url=it(e.url,s)}):e===z?(t.videoUrl=it(t.videoUrl,s),t.snapshotUrl=it(t.thumbUrl,s),t.snapshotHeight=t.thumbHeight,t.snapshotWidth=t.thumbWidth):e===K?t.url=it(t.url,s):e===J&&(t.fileUrl=it(t.fileUrl,s)))}}var co=class{constructor(e,t){if(this.type=ee,this.content={downloadKey:"",pbDownloadKey:"",messageList:[],title:"",abstractList:[],compatibleText:"",version:0,layersOverLimit:!1},e.downloadKey){const{downloadKey:t,pbDownloadKey:s,title:o,abstractList:r,compatibleText:i,version:n}=e;this.content.downloadKey=t,this.content.pbDownloadKey=s,this.content.title=o,this.content.abstractList=r,this.content.compatibleText=i,this.content.version=n||0}else if(Ue(e.messageList))1===e.layersOverLimit&&(this.content.layersOverLimit=!0);else{const{messageList:a,title:u,abstractList:l,compatibleText:h,version:g}=e,p=[];a.forEach(e=>{Ue(e)||(e=new lo(e,t),p.push(e))}),this.content.messageList=p,this.content.title=u,this.content.abstractList=l,this.content.compatibleText=h,this.content.version=g||0}}sendable(){return!Ue(this.content.messageList)||!Ue(this.content.downloadKey)}};const ho={1:te,2:se,3:oe,4:re};class go{constructor(e){this.ID="",this.conversationID=e.conversationID||null,this.conversationType=e.conversationType||ie,this.conversationSubType=e.conversationSubType,this.time=e.time||Math.ceil(Date.now()/1e3),this.sequence=e.sequence||0,this.clientSequence=e.clientSequence||e.sequence||0,this.random=e.random||0===e.random?e.random:Je(),this.priority=this._computePriority(e.priority),this.nick=e.nick||"",this.avatar=e.avatar||"",this.isPeerRead=!1,this.nameCard="",this.hasRiskContent=function(e){let t=e&&1<e?!0:!1;return t}(e.checkResult),this._elements=[],this.isPlaceMessage=e.isPlaceMessage||0,this.isRevoked=2===e.isPlaceMessage||8===e.msgFlagBits,this.from=e.from||null,this.to=e.to||null,this.flow="",this.isSystemMessage=e.isSystemMessage||!1,this.protocol=e.protocol||"JSON",this.isResend=!1,this.isRead=!1,this.status=e.status||Ws,this._onlineOnlyFlag=!1,this._groupAtInfoList=[],this._relayFlag=!1,this.atUserList=[],this.cloudCustomData=e.cloudCustomData||"",this.isDeleted=!1,this.isModified=!1,this._isExcludedFromUnreadCount=!(!e.messageControlInfo||1!==e.messageControlInfo.excludedFromUnreadCount),this._isExcludedFromLastMessage=!(!e.messageControlInfo||1!==e.messageControlInfo.excludedFromLastMessage),this.clientTime=e.clientTime||Math.floor(Ae()/1e3)||0,this.senderTinyID=e.senderTinyID||e.tinyID||"",this.readReceiptInfo=e.readReceiptInfo||{readCount:void 0,unreadCount:void 0,isPeerRead:void 0,timestamp:0},this.needReadReceipt=!0===e.needReadReceipt||1===e.needReadReceipt,this.version=e.messageVersion||0,this.isBroadcastMessage=e.isBroadcastMessage||!1,this._receiverList=e.receiverList||void 0,this.isSupportExtension=!0===e.isSupportExtension||1===e.isSupportExtension,this._cmConfigID=e.customModerationConfigurationID,this.revoker=e.revokerInfo&&e.revokerInfo.revoker||"",this.revokerInfo=e.revokerInfo||{userID:"",nick:"",avatar:""},this.revokeReason=e.revokeReason||"",this.reInitialize(e.currentUser),this.extractGroupInfo(e.groupProfile||null),this.handleGroupAtInfo(e),this.initC2CReadReceiptInfo(e)}get elements(){return this._elements}getElements(){return this._elements}extractGroupInfo(e){null!==e&&(Fe(e.nick)&&(this.nick=e.nick),Fe(e.avatar)&&(this.avatar=e.avatar),e=e["messageFromAccountExtraInformation"],xe(e)&&Fe(e.nameCard)&&(this.nameCard=e.nameCard))}handleGroupAtInfo(e){e.payload&&e.payload.atUserList&&e.payload.atUserList.forEach(e=>{e!==Te?(this._groupAtInfoList.push({groupAtAllFlag:0,groupAtUserID:e}),this.atUserList.push(e)):(this._groupAtInfoList.push({groupAtAllFlag:1}),this.atUserList.push(Te))}),Ve(e.groupAtInfo)&&e.groupAtInfo.forEach(e=>{0===e.groupAtAllFlag?this.atUserList.push(e.groupAtUserID):1===e.groupAtAllFlag&&this.atUserList.push(Te)})}getGroupAtInfoList(){return this._groupAtInfoList}_initProxy(){this._elements[0]&&(this.payload=this._elements[0].content,this.type=this._elements[0].type)}reInitialize(e){e&&(this.status=this.from?Ws:Js,this.from||(this.from=e)),this._initFlow(e),this._initSequence(e),this._concatConversationID(e),this.generateMessageID()}isSendable(){return 0!==this._elements.length&&(!0===this._relayFlag||"function"==typeof this._elements[0].sendable&&this._elements[0].sendable())}_initTo(e){this.conversationType===ne&&(this.to=e.groupID)}_initSequence(e){0===this.clientSequence&&e&&(this.clientSequence=function(o){if(!o)return!1;if(void 0===We[o]){const r=new Date;let e=("3"+r.getHours()).slice(-2),t=("0"+r.getMinutes()).slice(-2),s=("0"+r.getSeconds()).slice(-2);We[o]=parseInt([e,t,s,"0001"].join("")),e=null,t=null,s=null,lt.l("autoIncrementIndex start index:"+We[o])}return We[o]++}(e)),0===this.sequence&&this.conversationType===ie&&(this.sequence=this.clientSequence)}generateMessageID(){this.from===ue&&(this.senderTinyID="144115198244471703"),this.ID=`${this.senderTinyID}-${this.clientTime}-`+this.random}_initFlow(e){""!==e&&(e===this.from?(this.flow="out",this.isRead=!0):this.flow="in")}_concatConversationID(e){var t=this["to"],s=this.conversationType;s!==ue?(e=s===ie?e===this.from?t:this.from:this.to,this.conversationID=e?""+s+e:null):this.conversationID=ue}isElement(e){return e instanceof Qs||e instanceof Zs||e instanceof eo||e instanceof to||e instanceof no||e instanceof uo||e instanceof oo||e instanceof io||e instanceof ao||e instanceof po||e instanceof co}setElement(t,s){if(this.isElement(t))return this._elements=[t],void this._initProxy();var o=e=>{if(e.type&&e.content)switch(e.type){case j:this.setTextElement(e.content);break;case B:this.setImageElement(e.content,s);break;case K:this.setAudioElement(e.content,s);break;case J:this.setFileElement(e.content,s);break;case z:this.setVideoElement(e.content,s);break;case Z:this.setCustomElement(e.content);break;case X:this.setLocationElement(e.content);break;case Y:this.setGroupTipElement(e.content);break;case Q:this.setGroupSystemNoticeElement(e.content);break;case W:this.setFaceElement(e.content);break;case ee:this.setMergerElement(e.content,s)}};if(Ve(t))for(let e=0;e<t.length;e++)o(t[e]);else o(t);this._initProxy()}clearElement(){this._elements.length=0}setTextElement(e){e="string"==typeof e?e:e.text,e=new Qs({text:e});this._elements.push(e)}setImageElement(e,t){e=new Zs(e,t);this._elements.push(e)}setAudioElement(e,t){e=new to(e,t);this._elements.push(e)}setFileElement(e,t){e=new no(e,t);this._elements.push(e)}setVideoElement(e,t){e=new uo(e,t);this._elements.push(e)}setLocationElement(e){e=new po(e);this._elements.push(e)}setCustomElement(e){e=new ao(e);this._elements.push(e)}setGroupTipElement(e){let t={};var s=e.operationType;if(Ue(e.memberInfoList)?e.operatorInfo&&(t=e.operatorInfo):s!==De&&s!==Le&&s!==ye&&s!==Ge||(t=e.memberInfoList[0]),!Ue(e.memberExtraInfo)){const t=e.memberExtraInfo["reason"];e.msgMemberInfo.forEach(e=>{e.reason=t})}var{nick:s,avatar:o}=t,s=(Fe(s)&&(this.nick=s),Fe(o)&&(this.avatar=o),new oo(e));this._elements.push(s)}setGroupSystemNoticeElement(e){e=new io(e);this._elements.push(e)}setFaceElement(e){e=new eo(e);this._elements.push(e)}setMergerElement(e,t){e=new co(e,t);this._elements.push(e)}setIsRead(e){this.isRead=e}setRelayFlag(e){this._relayFlag=e}_computePriority(e){if(He(e))return se;if(Fe(e)&&-1!==Object.values(ho).indexOf(e))return e;if(Oe(e)){e=""+e;if(-1!==Object.keys(ho).indexOf(e))return ho[e]}return se}setNickAndAvatar(e){var{nick:e,avatar:t}=e;Fe(e)&&(this.nick=e),Fe(t)&&(this.avatar=t)}setNameCard(e){Fe(e)&&(this.nameCard=e)}initC2CReadReceiptInfo(e){var{readReceiptSentByPeer:e,timestamp:t=0}=e;this.conversationType===ie&&!0===this.needReadReceipt&&(this.readReceiptInfo.isPeerRead=1===e,this.readReceiptInfo.timestamp=t)}}class mo{constructor(e){this._grpM=e,this._n="GroupTipsHandler",this._cachedGroupTipsMap=new Map,this._checkCountMap=new Map,this.MAX_CHECK_COUNT=4}onCheckTimer(e){e%1==0&&0<this._cachedGroupTipsMap.size&&this._checkCachedGroupTips()}_checkCachedGroupTips(){this._cachedGroupTipsMap.forEach((e,t)=>{let s=this._checkCountMap.get(t);var o=this._grpM.hasLocalGroup(t);lt.l(this._n+`._checkCachedGroupTips groupID:${t} hasLocalGroup:${o} checkCount:`+s),o?(this._notifyCachedGroupTips(t),this._checkCountMap.delete(t),this._grpM.deleteUnjoinedAVChatRoom(t)):s>=this.MAX_CHECK_COUNT?(this._deleteCachedGroupTips(t),this._checkCountMap.delete(t)):(s++,this._checkCountMap.set(t,s))})}onNewGroupTips(e){lt.l(this._n+".onNewGroupTips options:"+JSON.stringify(e.dataList));var{eventDataList:e,result:t,AVChatRoomMessageList:s}=this._assembly(e);0<s.length&&this._grpM.onAVChatRoomMessage(s),0<e.length&&(this._grpM.updateNextMessageSeq(e),this._grpM.get(o).onNewMessage({conversationOptionsList:e,isInstantMessage:!0})),0<t.length&&(this._grpM.emitOEvt(qt,t),this.handleMessageList(t))}_assembly(s){var{event:r,dataList:c}=s;let i=null;const n=[],a=[],u={},m=[];for(let e=0,t=c.length;e<t;e++){const s=ze(c[e]);if(6===r){if(this._grpM.isGroupAttributesUpdatedNotice(s))continue;if(this._grpM.isGroupCountersNotice(s))continue}var{groupProfile:{groupID:p,communityType:d=0,topicID:_,invisible:M}}=s;let t=void 0;var f=this._grpM.isMessageFromTopic(d,_),l=(f&&(t=ae,s.to=_),this._grpM.hasLocalGroup(p));if(l||!this._grpM.isUnjoinedAVChatRoom(p))if(l||f)if(this._grpM.isMessageFromOrToAVChatroom(p))s.event=r,m.push(s);else if(s.currentUser=this._grpM.getMyUserID(),s.conversationType=ne,(i=new go(s)).setElement({type:Y,content:{...s.elements,groupProfile:s.groupProfile}}),i.isSystemMessage=!1,1!==M){const h=this._grpM.get(o),{conversationID:g,sequence:I}=i;if(6===r)i._onlineOnlyFlag=!0,a.push(i);else if(!h.pushIntoNoticeResult(a,i))continue;if(!(this._grpM.isMessageFromCommunityOfTopic(d,_)||6===r&&h.getLocalConversation(g))){6!==r&&this._qualityStat(i);l=h.isRemoteRead({conversationID:g,sequence:I});if(He(u[g])){let e=0;"in"===i.flow&&(i._isExcludedFromUnreadCount||i._onlineOnlyFlag||l||(e=1)),u[g]=n.push({conversationID:g,unreadCount:e,type:He(t)?i.conversationType:t,subType:i.conversationSubType,lastMessage:i._isExcludedFromLastMessage?"":i})-1}else{const s=u[g];n[s].type=i.conversationType,n[s].subType=i.conversationSubType,n[s].lastMessage=i._isExcludedFromLastMessage?"":i,"in"===i.flow&&(i._isExcludedFromUnreadCount||i._onlineOnlyFlag||l||n[s].unreadCount++)}}}else this._qualityStat(i);else this._cacheGroupTipsAndProbe({groupID:p,event:r,item:s})}return{eventDataList:n,result:a,AVChatRoomMessageList:m}}_qualityStat(e){this._grpM.get(u).addMessageSequence({key:zt,message:e})}handleMessageList(e){e.forEach(e=>{switch(e.payload.operationType){case 1:this._onNewMemberComeIn(e);break;case 2:this._onMemberQuit(e);break;case 3:this._onMemberKickedOut(e);break;case 4:this._onMemberSetAdmin(e);break;case 5:this._onMemberCancelledAdmin(e);break;case 6:this._onGroupProfileModified(e);break;case 7:this._onMemberInfoModified(e);break;case 8:this._onTopicProfileUpdated(e);break;default:lt.w(this._n+".handleMessageList unknown operationType:"+e.payload.operationType)}})}_onNewMemberComeIn(e){const{memberNum:t,groupProfile:{groupID:s}}=e.payload,o=this._grpM.getLocalGroupProfile(s);o&&Oe(t)&&o.memberCount!==t&&(o.memberCount=t,this._updateConvGroupProfile(o))}_onMemberQuit(e){const{memberNum:t,groupProfile:{groupID:s}}=e.payload,o=this._grpM.getLocalGroupProfile(s);o&&Oe(t)&&o.memberCount!==t&&(o.memberCount=t,this._updateConvGroupProfile(o)),this._grpM.getGroupMemberHandler().deleteLocalGroupMembers(s,e.payload.userIDList)}_onMemberKickedOut(e){const{memberNum:t,groupProfile:{groupID:s}}=e.payload,o=this._grpM.getLocalGroupProfile(s);o&&Oe(t)&&o.memberCount!==t&&(o.memberCount=t,this._updateConvGroupProfile(o)),this._grpM.getGroupMemberHandler().deleteLocalGroupMembers(s,e.payload.userIDList)}_updateConvGroupProfile(e){this._grpM.get(o).updateConvGroupProfile([e])}_onMemberSetAdmin(e){const s=e.payload.groupProfile.groupID,t=e.payload.userIDList,o=this._grpM.getGroupMemberHandler();t.forEach(e=>{const t=o.getLocalGroupMemberInfo(s,e);t&&t.updateRole(fe)})}_onMemberCancelledAdmin(e){const s=e.payload.groupProfile.groupID,t=e.payload.userIDList,o=this._grpM.getGroupMemberHandler();t.forEach(e=>{const t=o.getLocalGroupMemberInfo(s,e);t&&t.updateRole(Me)})}_onGroupProfileModified(e){const{newGroupProfile:t,groupProfile:s}=e.payload,o=s["groupID"],r=this._grpM.getLocalGroupProfile(o);Object.keys(t).forEach(e=>{switch(e){case"ownerID":this._ownerChanged(r,t);break;case"groupName":r.name=t[e];break;default:r[e]=t[e]}});e=!r.isSupportTopic;this._grpM.emitGroupListUpdate(!0,e)}_ownerChanged({groupID:e},t){const s=this._grpM.getLocalGroupProfile(e),o=this._grpM.getMyUserID();if(o===t.ownerID){s.updateGroup({selfInfo:{role:_e}});const t=this._grpM.getGroupMemberHandler(),r=t.getLocalGroupMemberInfo(e,o),i=this._grpM.getLocalGroupProfile(e).ownerID,n=t.getLocalGroupMemberInfo(e,i);r&&r.updateRole(_e),n&&n.updateRole(Me)}}_onMemberInfoModified(e){const{to:t,payload:{groupProfile:s,memberList:o}}=e,r=s.groupID,i=(st(t)&&this._updateTopicMuteTime(e),this._grpM.getGroupMemberHandler());o.forEach(e=>{const t=i.getLocalGroupMemberInfo(r,e.userID);t&&Oe(e.muteTime)&&t.updateMuteUntil(e.muteTime)})}_updateTopicMuteTime(e){const{to:t,payload:{groupProfile:o,memberList:r=[]}}=e,i=this._grpM.get(s),n=o["groupID"],a=i.getLocalTopic(n,t);if(a){let t=!1;for(let e=0;e<r.length;e++){const s=r[e];if(s.userID===this._grpM.getMyUserID()&&0<=s.muteTime){a.updateSelfInfo({muteTime:s.muteTime}),t=!0;break}}t&&this._grpM.emitOEvt(Ht,{groupID:n,topic:a})}}_onTopicProfileUpdated(e){var{groupProfile:{groupID:t},newTopicInfo:o}=e.payload;this._grpM.get(s).onTopicProfileUpdated({groupID:t,topicID:e.to,...o})}_cacheGroupTips(e,t){this._cachedGroupTipsMap.has(e)||this._cachedGroupTipsMap.set(e,[]),this._cachedGroupTipsMap.get(e).push(t)}_deleteCachedGroupTips(e){this._cachedGroupTipsMap.has(e)&&this._cachedGroupTipsMap.delete(e)}_notifyCachedGroupTips(e){const t=this._cachedGroupTipsMap.get(e)||[];t.forEach(e=>{this.onNewGroupTips(e)}),this._deleteCachedGroupTips(e),lt.l(this._n+`._notifyCachedGroupTips groupID:${e} count:`+t.length)}_cacheGroupTipsAndProbe(e){const{groupID:s,event:t,item:o}=e;this._cacheGroupTips(s,{event:t,dataList:[o]}),this._grpM.getGroupSimplifiedInfo(s).then(e=>{var t=e["type"];t===he?this._grpM.hasLocalGroup(s)?this._notifyCachedGroupTips(s):this._grpM.setUnjoinedAVChatRoom(s):(this._grpM.updateGroupMap([e]),this._notifyCachedGroupTips(s))}),this._checkCountMap.has(s)||this._checkCountMap.set(s,0),lt.l(this._n+"._cacheGroupTipsAndProbe groupID:"+s)}reset(){this._cachedGroupTipsMap.clear(),this._checkCountMap.clear()}}class _o{constructor(e){this._grpM=e,this._n="CommonGroupHandler",this.tempConversationList=null,this._cachedGroupMessageMap=new Map,this._checkCountMap=new Map,this.MAX_CHECK_COUNT=4,this.PAGING_GRP_COUNT_LIMIT=200,this._pagingStatus=zs,this._pagingGetCostList=[],e.getIEmitInst().on(Wt.A2KEY_AND_TINYID_UPDATED,this.syncGroupList,this)}onCheckTimer(e){e%1==0&&0<this._cachedGroupMessageMap.size&&this._checkCachedGroupMessage()}_checkCachedGroupMessage(){this._cachedGroupMessageMap.forEach((e,t)=>{let s=this._checkCountMap.get(t);var o=this._grpM.hasLocalGroup(t);lt.l(this._n+`._checkCachedGroupMessage groupID:${t} hasLocalGroup:${o} checkCount:`+s),o?(this._notifyCachedGroupMessage(t),this._checkCountMap.delete(t),this._grpM.deleteUnjoinedAVChatRoom(t)):s>=this.MAX_CHECK_COUNT?(this._deleteCachedGroupMessage(t),this._checkCountMap.delete(t)):(s++,this._checkCountMap.set(t,s))})}updateLastMsg(i){var e=this._n+".updateLastMsg";if(0!==this._grpM.getGroupMap().size){let t,s,o,r=!1;var n,a,u=i.length;for(let e=0;e<u;e++)(t=i[e]).type===ne&&0!==t.lastMessage.lastSequence&&null!==t.lastMessage.payload&&(s=t.conversationID.split(/^GROUP/)[1],(o=this._grpM.getLocalGroupProfile(s))&&(n=o.lastMessage,a=t.lastMessage,JSON.stringify(n)!==JSON.stringify(a)&&(o.lastMessage={...t.lastMessage},r=!0)));lt.l(e+` convCount:${u} groupCount:${this._grpM.getLocalGroupList().length} isUpdated:`+r),r&&(this._grpM.sortLocalGroupList(),this._grpM.emitGroupListUpdate(!0,!1))}else this.tempConversationList=i}onNewMessage(e){const{conversationOptionsList:t,messageList:s,AVChatRoomMessageList:r}=this._assembly(e);0<r.length&&this._grpM.onAVChatRoomMessage(r);var i=Ye(s),i=(0<i.length&&this._grpM.emitOEvt(kt,i),0<t.length&&(this._grpM.updateNextMessageSeq(t),this._grpM.get(o).onNewMessage({conversationOptionsList:t,isInstantMessage:e.isInstantMessage||!0,updateUnreadCount:e.updateUnreadCount||!0})),Qe(s));0<i.length&&this._grpM.emitOEvt(qt,i),s.length=0}_assembly(i){const{dataList:n,event:e,isInstantMessage:m}=i;let a=null;const u=[],p=[],d=[],l={},_=this._grpM.getFileDownloadProxy(),h=n.length,g=(1<h&&n.sort((e,t)=>e.sequence-t.sequence),this._grpM.get(o)),M=this._grpM.get(t);for(let r=0;r<h;r++){const i=ze(n[r]),{groupProfile:{groupID:o,communityType:h=0,topicID:c,invisible:D}}=i;let s=void 0;var f=this._grpM.isMessageFromTopic(h,c),I=(f&&(s=ae,i.to=c),this._grpM.hasLocalGroup(o));if(I||!this._grpM.isUnjoinedAVChatRoom(o))if(I||f)if(this._grpM.isMessageFromOrToAVChatroom(o))i.event=e,d.push(i);else if(i.currentUser=this._grpM.getMyUserID(),i.conversationType=ne,i.isSystemMessage=!!i.isSystemMessage,(a=new go(i)).setElement(i.elements,_),1!==D){let e=1===n[r].isModified;if(g.isMessageSentByCurrentInstance(a)?a.isModified=e:e=!1,1===i.onlineOnlyFlag)a._onlineOnlyFlag=!0,g.isMessageSentByCurrentInstance(a)||p.push(a);else{if(this._grpM.isMessageFromCommunityOfTopic(h,c)){p.push(a);continue}if(a.from===this._grpM.getMyUserID()){const t=g.getLatestMessageSentByMe(a.conversationID);if(t){const{nick:n,avatar:o}=t;n===a.nick&&o===a.avatar||(g.modifyMessageSentByMe({conversationID:i,latestNick:a.nick,latestAvatar:a.avatar}),M.mockOnNickAvatarModified(a.nick,a.avatar))}}if(!g.pushIntoMessageList(p,a,e))continue;this._qualityStat(m,a);const{conversationID:i,sequence:t}=a,n=g.isRemoteRead({conversationID:i,sequence:t});if(He(l[i])){let e=0;"in"===a.flow&&(a._isExcludedFromUnreadCount||n||(e=1)),l[i]=u.push({conversationID:i,unreadCount:e,type:He(s)?a.conversationType:s,subType:a.conversationSubType,lastMessage:a._isExcludedFromLastMessage?"":a})-1}else{const t=l[i];u[t].type=He(s)?a.conversationType:s,u[t].subType=a.conversationSubType,u[t].lastMessage=a._isExcludedFromLastMessage?"":a,"in"===a.flow&&(a._isExcludedFromUnreadCount||n||u[t].unreadCount++)}}}else this._qualityStat(m,a);else this._cacheGroupMessageAndProbe({groupID:o,event:e,item:i})}return{conversationOptionsList:u,messageList:p,AVChatRoomMessageList:d}}_qualityStat(e,t){const s=this._grpM.get(u);s.addMessageSequence({key:zt,message:t}),e&&0<t.clientTime&&s.addMessageDelay(t.clientTime)}onMsgRevoked(e){const p=this._grpM.get(o),l=[],h=[];e.dataList.forEach(e=>{const t=e.elements["revokedInfos"],{revokerInfo:n,groupProfile:a}=e;let u=!1;a&&(u=et({groupID:a.groupID})||!Ue(a.topicID)),He(t)||t.forEach(e=>{var t=Ue(e.topicID)?"GROUP"+e.groupID:"GROUP"+e.topicID,s=p.getLocalConversation(t),o=e.revokerInfo&&e.revokerInfo.revoker||n&&n.revoker,r=n&&n.reason||"";let i;if(s&&Ze(s.type))i={conversationID:t,sequence:e.sequence,ID:`${e.tinyID}-${e.clientTime}-`+e.random};else{const l=p.revoke(t,e.sequence,e.random);l?i=l:(i={conversationID:t,sequence:e.sequence},e.tinyID&&e.clientTime&&e.random&&(i.ID=`${e.tinyID}-${e.clientTime}-`+e.random),e.time&&(i.time=e.time))}i&&(i.revoker=o,i.revokeReason=r,i.revokerInfo={userID:o,nick:"",avatar:""},u?(i.revokerInfo.nick=a.nick,i.revokerInfo.avatar=a.avatar,l.push(i)):h.push(i))})}),0===h.length&&0===l.length||(p.onMessageRevoked([...l,...h]),0<l.length&&this._grpM.emitOEvt(Ot,l),0<h.length&&p.updateRevokerInfo(h).then(e=>{this._grpM.emitOEvt(Ot,e)}))}_groupListTreeShaking(s){const o=new Map([...this._grpM.getGroupMap()]);for(let e=0,t=s.length;e<t;e++)o.delete(s[e].groupID);this._grpM.hasJoinedAVChatRoom()&&this._grpM.getJoinedAVChatRoom().forEach(e=>{o.delete(e)}),this._grpM.getGroupMap().forEach((e,t)=>{e.isSupportTopic&&o.delete(t)});var r=[...o.keys()];for(let e=0,t=r.length;e<t;e++)this._grpM.deleteGroup(r[e])}syncGroupList(e=!1){this._pagingStatus===zs&&this._grpM.clearGroupMap();const t=[...L],s=this.PAGING_GRP_COUNT_LIMIT,o=[];if(!0===e)return this._pagingGetGroupListWithTopic({limit:s,offset:0,groupBaseInfoFilter:t,groupList:o});const r=this._n+".syncGroupList",i=new ts("syncGroupList");return this._pagingGetGroupList({limit:s,offset:0,groupBaseInfoFilter:t,groupList:o}).then(()=>{var e=function(e){if(Ve(e)&&0!==e.length){let t=0;return e.forEach(e=>{t+=e}),(t/e.length).toFixed(0)}}(this._pagingGetCostList),t=function(e){if(Ve(e)&&0!==e.length){let t=0;return e.forEach(e=>{t+=e}),t.toFixed(0)}}(this._pagingGetCostList),t=(this._pagingGetCostList.length=0,this._pagingStatus=Xs,this._groupListTreeShaking(o),this._grpM.updateGroupMap(o),`count:${this._grpM.getLocalGroupList().length} sum:${t} avg:`+e);return lt.l(r+" ok. "+t),i.setMessage(t).end(),this.tempConversationList&&(this.updateLastMsg(this.tempConversationList),this.tempConversationList=null),this._grpM.emitGroupListUpdate(!0,!0),ct({groupList:this._grpM.getLocalGroupList()})}).catch(e=>(this._pagingStatus=Ys,i.setError(e).end(),lt.e(r+" failed. error:",e),Jt(e)))}getGroupList(){const t=this._n+".getGroupList";if(lt.l(t+" pagingStatus:"+this._pagingStatus),this._pagingStatus===Ys||this._pagingStatus===zs)return this.syncGroupList().then(()=>{var e=this._grpM.getLocalGroupList();return ct({groupList:e,isSyncCompleted:this.isPagingGetCompleted()})}).catch(e=>(lt.e(t+" failed. error:",e),Jt(e)));var e=this._grpM.getLocalGroupList();return lt.l(t+". returned group count:"+e.length),Kt({groupList:e,isSyncCompleted:this.isPagingGetCompleted()})}isPagingGetCompleted(){return this._pagingStatus===Xs}_pagingGetGroupList(e){const o=this._n+"._pagingGetGroupList";let{isCommunityRelay:r=!1,limit:i,offset:n,groupBaseInfoFilter:a,groupList:u}=e;const p=Date.now();return this._grpM.req({P:os,data:{type:r?ge:void 0,memberAccount:this._grpM.getMyUserID(),limit:i,offset:n,responseFilter:{groupBaseInfoFilter:a,selfInfoFilter:["Role","JoinTime","MsgFlag","MsgSeq"]}}}).then(e=>{var{groups:e=[],totalCount:t}=e.data,e=(u.push(...e),this._handleGroupAtInfoWithoutTopic(r,e),n+i),s=!(e<t),t=`offset:${n} limit:${i} total:${t} isCompleted:${s} current:${u.length} isCommunityRelay:`+r;return this._pagingGetCostList.push(nt(p,!1)),lt.l(o+` ok. ${t} cost:`+nt(p)),r||s?!r&&s?(lt.l(o+" start to get community list"),n=0,this._pagingGetGroupList({limit:i,offset:n,groupBaseInfoFilter:a,groupList:u,isCommunityRelay:!0})):r&&!s?(n=e,this._pagingGetGroupList({limit:i,offset:n,groupBaseInfoFilter:a,groupList:u,isCommunityRelay:!0})):ct({groupList:u}):(n=e,this._pagingGetGroupList({limit:i,offset:n,groupBaseInfoFilter:a,groupList:u}))}).catch(e=>10018===e.code?(lt.w(this.logPrefix+" response size exceeds the limit, request count:"+i),i=50,this._pagingGetGroupList({limit:i,offset:n,groupBaseInfoFilter:a,groupList:u,isCommunityRelay:r})):r?(11e3===e.code&&lt.l(o+" ok. community unavailable"),Kt({groupList:u})):Jt(e))}_pagingGetGroupListWithTopic(e){const o=this._n+"._pagingGetGroupListWithTopic";let{limit:r,offset:i,groupBaseInfoFilter:n,groupList:a}=e;const u=Date.now();return this._grpM.req({P:os,data:{type:ge,memberAccount:this._grpM.getMyUserID(),limit:r,offset:i,responseFilter:{groupBaseInfoFilter:n,selfInfoFilter:[...y]},isSupportTopic:1}}).then(e=>{var{groups:e=[],totalCount:t}=e.data,e=(a.push(...e),i+r),s=!(e<t);if(lt.l(o+` ok. offset:${i} limit:${r} totalCount:${t} isCompleted:${s} currentCount:${a.length} cost:`+nt(u)),!s)return i=e,this._pagingGetGroupListWithTopic({limit:r,offset:i,groupBaseInfoFilter:n,groupList:a});this._grpM.updateGroupMap(a),this._grpM.emitGroupListUpdate(!0,!1);t=this._grpM.getLocalGroupList().filter(e=>!0===e.isSupportTopic);return ct({groupList:t})}).catch(e=>10018===e.code?(lt.w(this.logPrefix+" response size exceeds the limit, request count:"+r),r=50,this._pagingGetGroupListWithTopic({limit:r,offset:i,groupBaseInfoFilter:n,groupList:a})):Jt(e))}_cacheGroupMessage(e,t){this._cachedGroupMessageMap.has(e)||this._cachedGroupMessageMap.set(e,[]),this._cachedGroupMessageMap.get(e).push(t)}_deleteCachedGroupMessage(e){this._cachedGroupMessageMap.has(e)&&this._cachedGroupMessageMap.delete(e)}_notifyCachedGroupMessage(e){const t=this._cachedGroupMessageMap.get(e)||[];t.forEach(e=>{this.onNewMessage(e)}),this._deleteCachedGroupMessage(e),lt.l(this._n+`._notifyCachedGroupMessage groupID:${e} count:`+t.length)}_cacheGroupMessageAndProbe(e){const{groupID:s,event:t,item:o}=e;this._cacheGroupMessage(s,{event:t,dataList:[o]}),this._grpM.getGroupSimplifiedInfo(s).then(e=>{var t=e["type"];t===he?this._grpM.hasLocalGroup(s)?this._notifyCachedGroupMessage(s):this._grpM.setUnjoinedAVChatRoom(s):(this._grpM.updateGroupMap([e]),this._notifyCachedGroupMessage(s))}),this._checkCountMap.has(s)||this._checkCountMap.set(s,0),lt.l(this._n+"._cacheGroupMessageAndProbe groupID:"+s)}_handleGroupAtInfoWithoutTopic(e,t){e&&0!==t.length&&t.forEach(e=>{const{groupID:t,groupAtInfoList:s}=e,r=[];He(s)||(s.forEach(e=>{r.push({...e,groupID:t})}),this._grpM.get(o).onNewGroupAtTips({dataList:r}))})}setPagingGroupCount(e){He(e)||(this.PAGING_GRP_COUNT_LIMIT=parseInt(e,10))}reset(){this.PAGING_GRP_COUNT_LIMIT=200,this._cachedGroupMessageMap.clear(),this._checkCountMap.clear(),this._pagingStatus=zs,this._pagingGetCostList=[]}}const fo=1,Mo=2,Io=3,Do=4,Lo=5;class yo{constructor(e){this._grpM=e,this._n="GroupAttributesHandler",this._groupAttributesMap=new Map,this._groupAttributesCopy={},this.CACHE_EXPIRE_TIME=3e4,this._grpM.getIEmitInst().on(Wt.CLOUD_CONFIG_UPDATED,this._onCloudConfigUpdated,this)}_onCloudConfigUpdated(){var e=this._grpM.getCloudConfig("grp_attr_cache_time");He(e)||(this.CACHE_EXPIRE_TIME=Number(e))}updateLocalMainSequenceOnReconnected(){this._groupAttributesMap.forEach(e=>{e.localMainSequence=0})}isGroupAttributesUpdatedNotice(e){var{to:e,elements:{newGroupProfile:t}}=e,s=!He(t)&&!Ue(t.groupAttributeOption);return s&&this._onGroupAttributesUpdated({groupID:e,groupAttributeOption:t.groupAttributeOption}),s}_onGroupAttributesUpdated(e){const{groupID:t,groupAttributeOption:s}=e,{mainSequence:o,isWithChangedAttributeInfo:r,groupAttributeList:i=[],operationType:n}=s;if(lt.l(this._n+".onGroupAttributesUpdated. "+`groupID:${t} isWithChangedAttributeInfo:${r} operationType:`+n),!He(n)){this._groupAttributesCopy=this._getCachedAttributes({groupID:t});e=this._getLocalGroupAttributes(t)["localMainSequence"],e=o-e;if(0!=e){if(1===r&&1==e)return this._refreshCachedGroupAttributes({groupID:t,remoteMainSequence:o,groupAttributeList:i,operationType:n}),void this._emitGroupAttributesUpdated(t);if(this._hasLocalGroupAttributes(t)){const e=this._getLocalGroupAttributes(t)["avChatRoomKey"];this._getGroupAttributes({groupID:t,avChatRoomKey:e}).then(()=>{this._emitGroupAttributesUpdated(t)})}}}}initGroupAttributesCache(e){var{groupID:e,avChatRoomKey:t}=e;this._groupAttributesMap.set(e,{lastUpdateTime:0,localMainSequence:0,remoteMainSequence:0,attributes:new Map,avChatRoomKey:t}),lt.l(this._n+`.initGroupAttributesCache groupID:${e} avChatRoomKey:`+t)}initGroupAttributes(e){const{groupID:r,groupAttributes:i}=e,{remoteMainSequence:t,avChatRoomKey:s}=this._getLocalGroupAttributes(r),n=new ts("initGroupAttributes");return n.setMessage(`groupID:${r} avChatRoomKey:${s} mainSequence:`+t),this._grpM.req({P:Ss,data:{groupID:r,avChatRoomKey:s,mainSequence:t,groupAttributeList:this._transformGroupAttributes(i)}}).then(e=>{lt.l(this._n+".initGroupAttributes ok. groupID:"+r);const{mainSequence:t,groupAttributeList:s}=e.data,o=[...s];return o.forEach(e=>{e.value=i[e.key]}),this._groupAttributesCopy=this._getCachedAttributes({groupID:r}),this._refreshCachedGroupAttributes({groupID:r,remoteMainSequence:t,groupAttributeList:o,operationType:fo}),this._emitGroupAttributesUpdated(r),n.end(),ct({groupAttributes:i})}).catch(e=>(n.setError(e).end(),Jt(e)))}setGroupAttributes(e){const r=this._n+".setGroupAttributes",{groupID:i,groupAttributes:n}=e,{remoteMainSequence:t,avChatRoomKey:s,attributes:o}=this._getLocalGroupAttributes(i),a=this._transformGroupAttributes(n),u=(a.forEach(e=>{var t=e["key"];e.sequence=0,o.has(t)&&(e.sequence=o.get(t).sequence)}),new ts("setGroupAttributes"));return u.setMessage(`groupID:${i} groupAttributes:`+JSON.stringify(n)),lt.l(r+`. groupID:${i} mainSequence:`+t),this._grpM.req({P:Ps,data:{groupID:i,avChatRoomKey:s,mainSequence:t,groupAttributeList:a}}).then(e=>{lt.l(r+" ok.");const{mainSequence:t,groupAttributeList:s}=e.data,o=[...s];return o.forEach(e=>{e.value=n[e.key]}),this._groupAttributesCopy=this._getCachedAttributes({groupID:i}),this._refreshCachedGroupAttributes({groupID:i,remoteMainSequence:t,groupAttributeList:o,operationType:Mo}),this._emitGroupAttributesUpdated(i),u.end(),ct({groupAttributes:n})}).catch(e=>(u.setError(e).end(),Jt(e)))}deleteGroupAttributes(l){const{groupID:t,keyList:e=[]}=l,{remoteMainSequence:s,avChatRoomKey:h,attributes:o}=this._getLocalGroupAttributes(t);let r=[...o.keys()],i=$s,n=Io;const a={groupID:t,avChatRoomKey:h,mainSequence:s},u=[],p=(0<e.length&&(r=[],i=Rs,n=Do,e.forEach(e=>{let t=0;o.has(e)&&(t=o.get(e).sequence,r.push(e)),u.push({key:e,sequence:t})}),a.groupAttributeList=u),new ts("deleteGroupAttributes"));return p.setMessage(`groupID:${t} mainSequence:${s} keyList:${e} proto:`+i),this._grpM.req({P:i,data:a}).then(e=>{lt.l(this._n+".deleteGroupAttributes ok. groupID:"+t);e=e.data.mainSequence;return this._groupAttributesCopy=this._getCachedAttributes({groupID:t}),this._refreshCachedGroupAttributes({groupID:t,remoteMainSequence:e,groupAttributeList:u,operationType:n}),this._emitGroupAttributesUpdated(t),p.end(),ct({keyList:r})}).catch(e=>(p.setError(e).end(),Jt(e)))}getGroupAttributes(t){const s=this._n+".getGroupAttributes",o=t["groupID"],{avChatRoomKey:e,lastUpdateTime:r,localMainSequence:i,remoteMainSequence:n}=this._getLocalGroupAttributes(o),a=new ts("getGroupAttributes");if(a.setMessage(`groupID:${o} localMainSequence:${i} remoteMainSequence:${n} keyList:`+t.keyList),Date.now()-r>=this.CACHE_EXPIRE_TIME||i<n)return this._getGroupAttributes({groupID:o,avChatRoomKey:e}).then(e=>{a.setMoreMessage("get attributes from remote. count:"+e.length).end(),lt.l(s+" from remote. groupID:"+o);e=this._getCachedAttributes(t);return ct({groupAttributes:e})}).catch(e=>(a.setError(e).end(),Jt(e)));a.setMoreMessage("get attributes from cache").end(),lt.l(s+" from cache. groupID:"+o);var u=this._getCachedAttributes(t);return Kt({groupAttributes:u})}_getGroupAttributes(o){let e=0;return He(o.avChatRoomKey)||(e=1),this._grpM.req({P:Es,data:{...o,groupType:e}}).then(e=>{lt.l(this._n+"._getGroupAttributes ok. groupID:"+o.groupID);var{mainSequence:e,groupAttributeList:t}=e.data,s=[...t];return He(e)||this._refreshCachedGroupAttributes({groupID:o.groupID,remoteMainSequence:e,groupAttributeList:s,operationType:Lo}),t}).catch(e=>Jt(e))}_refreshCachedGroupAttributes(e){var{groupID:t,remoteMainSequence:s,groupAttributeList:o,operationType:r}=e;if(this._hasLocalGroupAttributes(t)){const e=this._getLocalGroupAttributes(t),i=e["localMainSequence"];if(r===Lo||s-i==1)e.remoteMainSequence=s,e.localMainSequence=s,e.lastUpdateTime=Date.now(),this._updateCachedAttributes({groupAttributes:e,groupAttributeList:o,operationType:r});else{if(i===s)return;e.remoteMainSequence=s}this._groupAttributesMap.set(t,e);o=`operationType:${r} localMainSequence:${i} remoteMainSequence:`+s;lt.l(this._n+"._refreshCachedGroupAttributes. "+o)}}_getCachedAttributes(t){const{groupID:e,keyList:s=[]}=t,o={};if(this._hasLocalGroupAttributes(e)){const t=this._getLocalGroupAttributes(e)["attributes"];if(0<s.length)s.forEach(e=>{t.has(e)&&(o[e]=t.get(e).value)});else for(const e of t.keys())o[e]=t.get(e).value}return o}_updateCachedAttributes(e){const{groupAttributes:o,groupAttributeList:t,operationType:s}=e;s!==Io?s!==Do?(s===fo&&o.attributes.clear(),t.forEach(e=>{var{key:e,value:t,sequence:s}=e;o.attributes.set(e,{value:t,sequence:s})})):t.forEach(e=>{o.attributes.delete(e.key)}):o.attributes.clear()}_hasLocalGroupAttributes(e){return this._groupAttributesMap.has(e)}_getLocalGroupAttributes(e){return this._hasLocalGroupAttributes(e)||this.initGroupAttributesCache({groupID:e}),this._groupAttributesMap.get(e)}_transformGroupAttributes(t){const s=[];return Object.keys(t).forEach(e=>{s.push({key:e,value:t[e]})}),s}_emitGroupAttributesUpdated(e){var t=this._getCachedAttributes({groupID:e}),{updatedKeyList:s,deletedKeyList:o}=this._computeAttrChangedInfo(t);lt.l(`${this._n}._emitGroupAttributesUpdated update:${s.length}, delete:`+o.length),0===s.length&&0===o.length||this._grpM.emitOEvt(xt,{groupID:e,groupAttributes:t,updatedKeyList:s,deletedKeyList:o})}_computeAttrChangedInfo(t){const s=[],o=[];return Object.keys(t).forEach(e=>{t[e]!==this._groupAttributesCopy[e]&&s.push(e)}),Object.keys(this._groupAttributesCopy).forEach(e=>{He(t[e])&&o.push(e)}),this._groupAttributesCopy={},{updatedKeyList:s,deletedKeyList:o}}deleteLocalGroupAttributes(e){this._hasLocalGroupAttributes(e)&&this._groupAttributesMap.delete(e)}reset(){this._groupAttributesMap.clear(),this._groupAttributesCopy={},this.CACHE_EXPIRE_TIME=3e4}}const Go="Set",Co="Increase",bo="Decrease";class To{constructor(e){this._grpM=e,this._n="GroupCountersHandler",this._groupCountersMap=new Map,this.EXPIRE_TIME=3e4,this._grpM.getIEmitInst().on(Wt.CLOUD_CONFIG_UPDATED,this._onCloudConfigUpdated,this)}_onCloudConfigUpdated(){var e=this._grpM.getCloudConfig("grp_counter_expire_time");He(e)||(this.EXPIRE_TIME=Number(e))}isGroupCountersNotice(e){var{to:e,elements:{groupCounterInfo:t}}=e;let s=!1;return Ue(t)||(this._onGroupCountersUpdated({groupID:e,groupCounterInfo:t}),s=!0),s}_onGroupCountersUpdated(e){const{groupID:r,groupCounterInfo:t}=e;t.forEach(e=>{const{type:t,groupCounterSeq:s,counterList:o=[]}=e;0!==t&&2!==t||(this._updateLocalGroupCounters({groupID:r,groupCounterSeq:s,counterList:o}),o.forEach(e=>{this._grpM.emitOEvt(Vt,{groupID:r,key:e.key,value:e.value})})),1===t&&this._deleteLocalGroupCounters({groupID:r,groupCounterSeq:s,counterList:o})}),lt.l(this._n+"._onGroupCountersUpdated groupID:"+r)}initGroupCountersCache(e){var{groupID:e,avChatRoomKey:t}=e;this._groupCountersMap.set(e,{lastUpdateTime:0,groupCounterSeq:0,counters:new Map,avChatRoomKey:t}),lt.l(this._n+`.initGroupCountersCache groupID:${e} avChatRoomKey:`+t)}setGroupCounters(e){if(!this._grpM.canIUse(M.GRP_COUNTER))return this._grpM.noUse("setGroupCounters");const t=this._n+".setGroupCounters",{groupID:s,counters:o}=e,r=this._convertObjectToList(o),i=this._getLocalGroupCounters(s)["avChatRoomKey"],n=`groupID:${s} count:`+r.length,a=new ts("setGroupCounters");return a.setMessage(n),lt.l(t+". "+n),this._updateGroupCounters({groupID:s,counterList:r,avChatRoomKey:i,mode:Go}).then(e=>(a.end(),lt.l(t+" ok."),ct({counters:e}))).catch(e=>(a.setError(e).end(),lt.e(t+" failed. error:",e),Jt(e)))}increaseGroupCounter(e){var t="increaseGroupCounter";if(!this._grpM.canIUse(M.GRP_COUNTER))return this._grpM.noUse(t);const s=this._n+"."+t,{groupID:o,key:r,value:i}=e,n=this._getLocalGroupCounters(o)["avChatRoomKey"],a=`groupID:${o} key:${r} value:`+i,u=new ts(t);return u.setMessage(a),lt.l(s+". "+a),this._updateGroupCounters({groupID:o,counterList:[{key:r,value:i}],avChatRoomKey:n,mode:Co}).then(e=>(u.end(),lt.l(s+" ok."),ct({counters:e}))).catch(e=>(u.setError(e).end(),lt.e(s+" failed. error:",e),Jt(e)))}decreaseGroupCounter(e){var t="decreaseGroupCounter";if(!this._grpM.canIUse(M.GRP_COUNTER))return this._grpM.noUse(t);const s=this._n+"."+t,{groupID:o,key:r,value:i}=e,n=this._getLocalGroupCounters(o)["avChatRoomKey"],a=`groupID:${o} key:${r} value:`+i,u=new ts(t);return u.setMessage(a),lt.l(s+". "+a),this._updateGroupCounters({groupID:o,counterList:[{key:r,value:i}],avChatRoomKey:n,mode:bo}).then(e=>(u.end(),lt.l(s+" ok."),ct({counters:e}))).catch(e=>(u.setError(e).end(),lt.e(s+" failed. error:",e),Jt(e)))}getGroupCounters(e){if(!this._grpM.canIUse(M.GRP_COUNTER))return this._grpM.noUse("getGroupCounters");const t=this._n+".getGroupCounters",{groupID:s,keyList:o=[]}=e,{avChatRoomKey:r,lastUpdateTime:i}=this._getLocalGroupCounters(s),n=new ts("getGroupCounters");if(n.setMessage("groupID:"+s),Date.now()-i>=this.EXPIRE_TIME)return this._getRemoteGroupCounters({groupID:s,avChatRoomKey:r}).then(e=>{n.setMoreMessage("from remote. count:"+e.length).end(),lt.l(t+" from remote. groupID:"+s);e=this._getLocalCounters(s,o);return ct({counters:e})}).catch(e=>(n.setError(e).end(),Jt(e)));n.setMoreMessage("from cache").end(),lt.l(t+" from cache. groupID:"+s);e=this._getLocalCounters(s,o);return Kt({counters:e})}_getRemoteGroupCounters(s){return this._grpM.req({P:ks,data:{...s}}).then(e=>{var{counterList:e=[],groupCounterSeq:t}=e.data;return this._updateLocalGroupCounters({groupID:s.groupID,counterList:e,groupCounterSeq:t}),lt.l(this._n+"._getRemoteGroupCounters ok. groupID:"+s.groupID),e}).catch(e=>Jt(e))}_convertObjectToList(t){const s=[];return Object.keys(t).forEach(e=>{s.push({key:e,value:t[e]})}),s}_updateGroupCounters(e){const o=this._n+"._updateGroupCounters",{groupID:t,avChatRoomKey:s,mode:r}=e;return lt.l(o+`. groupID:${t} avChatRoomKey:${s} mode:`+r),this._grpM.req({P:qs,data:{...e}}).then(e=>{lt.l(o+" ok.");const{counterList:t=[]}=e.data,s={};return t.forEach(e=>{var{key:e,value:t}=e;s[e]=t}),s}).catch(e=>Jt(e))}_hasLocalGroupCounters(e){return this._groupCountersMap.has(e)}_getLocalGroupCounters(e){return this._hasLocalGroupCounters(e)||this.initGroupCountersCache({groupID:e}),this._groupCountersMap.get(e)}_updateLocalGroupCounters(s){const{groupID:e,counterList:t=[],groupCounterSeq:o}=s;if(this._hasLocalGroupCounters(e)){const{counters:s,avChatRoomKey:r,groupCounterSeq:i}=this._getLocalGroupCounters(e);0<o&&o<i||(t.forEach(e=>{var{key:e,value:t}=e;s.set(e,t)}),this._groupCountersMap.set(e,{lastUpdateTime:Date.now(),groupCounterSeq:o,counters:s,avChatRoomKey:r}))}}_deleteLocalGroupCounters(t){const{groupID:e,counterList:s=[],groupCounterSeq:o}=t;if(this._hasLocalGroupCounters(e)){const{counters:t,avChatRoomKey:r}=this._getLocalGroupCounters(e);s.forEach(e=>{t.delete(e.key)}),this._groupCountersMap.set(e,{lastUpdateTime:Date.now(),groupCounterSeq:o,counters:t,avChatRoomKey:r})}}_getLocalCounters(e,t){const s={};if(!this._hasLocalGroupCounters(e))return s;const o=this._getLocalGroupCounters(e)["counters"];if(0<t.length)t.forEach(e=>{o.has(e)&&(s[e]=o.get(e))});else for(const r of o.keys())s[r]=o.get(r);return s}reset(){this._groupCountersMap.clear(),this.EXPIRE_TIME=3e4}}class Ao{constructor(e){var{manager:e,groupID:t,onInit:s,onSuccess:o,onFail:r}=e;this._n="Polling",this._manager=e,this._grpM=e._grpM,this._onInit=s,this._onSuccess=o,this._onFail=r,this._groupID=t,this._timeoutID=-1,this._isRunning=!1,this._proto=Cs}start(){var e=this._grpM.isLoggedIn();e||(this._proto=bs),lt.l(`${this._n}.start pollingInterval:${this._manager.getPollingInterval()} isLoggedIn:`+e),this._isRunning=!0,this._request()}isRunning(){return this._isRunning}_request(){var e=this._onInit(this._groupID);this._grpM.req({P:this._proto,data:e}).then(e=>{this._onSuccess(this._groupID,e),this.isRunning()&&(clearTimeout(this._timeoutID),this._timeoutID=setTimeout(this._request.bind(this),this._manager.getPollingInterval()))}).catch(e=>{this._onFail(this._groupID,e),this.isRunning()&&(clearTimeout(this._timeoutID),this._timeoutID=setTimeout(this._request.bind(this),this._manager.MAX_POLLING_INTERVAL))})}stop(){lt.l(this._n+".stop"),0<this._timeoutID&&(clearTimeout(this._timeoutID),this._timeoutID=-1),this._isRunning=!1}getPollingTimerID(){return this._timeoutID}}class vo{constructor(e){this.value=e,this.next=null}}class So{constructor(e){this.MAX_LENGTH=e,this.pTail=null,this.pNodeToDel=null,this.map=new Map}set(t){var s=new vo(t);if(this.map.size<this.MAX_LENGTH)null===this.pTail?(this.pTail=s,this.pNodeToDel=s):(this.pTail.next=s,this.pTail=s),this.map.set(t,1);else{let e=this.pNodeToDel;this.pNodeToDel=this.pNodeToDel.next,this.map.delete(e.value),e.next=null,e=null,this.pTail.next=s,this.pTail=s,this.map.set(t,1)}}has(e){return this.map.has(e)}delete(e){this.has(e)&&this.map.delete(e)}tail(){return this.pTail}size(){return this.map.size}data(){return Array.from(this.map.keys())}reset(){let e;for(;null!==this.pNodeToDel;)e=this.pNodeToDel,this.pNodeToDel=this.pNodeToDel.next,e.next=null,e=null;this.pTail=null,this.map.clear()}}const Po=["groupID","name","avatar","type","introduction","notification","ownerID","selfInfo","createTime","infoSequence","lastInfoTime","lastMessage","nextMessageSeq","memberNum","maxMemberNum","memberList","joinOption","groupCustomField","muteAllMembers","isSupportTopic","inviteOption","_lastRevokedTime"];class Ro{constructor(e){this.groupID="",this.name="",this.avatar="",this.type="",this.introduction="",this.notification="",this.ownerID="",this.createTime="",this.infoSequence="",this.lastInfoTime="",this.selfInfo={messageRemindType:"",joinTime:"",nameCard:"",role:"",userID:"",memberCustomField:void 0,readedSequence:0,excludedUnreadSequenceList:void 0},this.lastMessage={lastTime:"",lastSequence:"",fromAccount:"",messageForShow:""},this.nextMessageSeq="",this.memberNum="",this.memberCount="",this.maxMemberNum="",this.maxMemberCount="",this.joinOption="",this.inviteOption="",this.groupCustomField=[],this.muteAllMembers=!1,this.isSupportTopic=!1,this._lastRevokedTime=0,this._initGroup(e)}set memberNum(e){}set maxMemberNum(e){}get memberNum(){return this.memberCount}get maxMemberNum(){return this.maxMemberCount}_initGroup(e){for(const t in e)Po.indexOf(t)<0||("selfInfo"!==t?("memberNum"===t&&(this.memberCount=e[t]),"maxMemberNum"===t&&(this.maxMemberCount=e[t]),"isSupportTopic"!==t?this[t]=e[t]:this.isSupportTopic=1===e[t]):this.updateSelfInfo(e[t]))}updateGroup(e){e.appid=void 0,e.grossTopicNextMsgSeq=void 0,e.selfInfo&&(e.selfInfo.grossTopicReadSeq=void 0);const t=JSON.parse(JSON.stringify(e));t.lastMsgTime&&(this.lastMessage.lastTime=t.lastMsgTime),He(t.muteAllMembers)||("On"===t.muteAllMembers?t.muteAllMembers=!0:t.muteAllMembers=!1),t.groupCustomField&&Xe(this.groupCustomField,t.groupCustomField),He(t.memberNum)||(this.memberCount=t.memberNum),He(t.maxMemberNum)||(this.maxMemberCount=t.maxMemberNum),He(t.isSupportTopic)||(this.isSupportTopic=Oe(t.isSupportTopic)?1===t.isSupportTopic:t.isSupportTopic),Ke(this,t,["members","errorCode","lastMsgTime","groupCustomField","memberNum","maxMemberNum","isSupportTopic"]),Ve(t.members)&&0<t.members.length&&t.members.forEach(e=>{e.userID===this.selfInfo.userID&&Ke(this.selfInfo,e,["sequence"])})}updateSelfInfo({nameCard:e,joinTime:t,role:s,messageRemindType:o,readedSequence:r,excludedUnreadSequenceList:i}){e={nameCard:e,joinTime:t,role:s,messageRemindType:o,readedSequence:r,excludedUnreadSequenceList:i};Ke(this.selfInfo,{...e},[],["",null,void 0,0,NaN])}setSelfNameCard(e){this.selfInfo.nameCard=e}}const $o={3:!0,4:!0,5:!0,6:!0,17:!0,20:!0,21:!0,100:!0};class Eo{constructor(e){this._grpM=e,this._n="AVChatRoomHandler",this._joinedGroupMap=new Map,this._pollingRequestInfoMap=new Map,this._pollingInstanceMap=new Map,this.sequencesLinkedList=new So(200),this.messageIDLinkedList=new So(100),this._reportMessageStackedCount=0,this._onlineMemberCountMap=new Map,this.DEFAULT_EXPIRE_TIME=60,this.DEFAULT_POLLING_INTERVAL=300,this.MAX_POLLING_INTERVAL=2e3,this._pollingInterval=this.DEFAULT_POLLING_INTERVAL,this.DEFAULT_POLLING_NO_MESSAGE_COUNT=20,this.DEFAULT_POLLING_INTERVAL_PLUS=2e3,this._pollingNoMessageCount=0,this._startBroadcastSeq=1,this._broadcastMessageIDMap=new Map,this.DEFAULT_POLLING_SIMPLIFIED_MSG=0}hasJoinedAVChatRoom(){let e=[];return 0<(e=0<this._joinedGroupMap.size?[...this._joinedGroupMap.values()].filter(e=>e.type===he):e).length}getJoinedLiveList(){let e=[];return e=0<this._joinedGroupMap.size?[...this._joinedGroupMap.values()].filter(e=>e.type===de):e}checkJoinedAVChatRoomByID(e){return this._joinedGroupMap.has(e)}getJoinedAVChatRoom(){return 0<this._joinedGroupMap.size?[...this._joinedGroupMap.keys()]:[]}_updatedata(e){var t=this._pollingRequestInfoMap.get(e);return e===[...this._pollingInstanceMap.keys()][0]?{...t,startBroadcastSeq:this._startBroadcastSeq,simplifiedMessage:this.DEFAULT_POLLING_SIMPLIFIED_MSG}:{...t,simplifiedMessage:this.DEFAULT_POLLING_SIMPLIFIED_MSG}}_handleSuccess(e,t){const{key:s,nextSeq:o,rspMsgList:r,errorCode:i,nextBroadcastSeq:n,broadcastMessageList:a}=t.data;if(0!==i){const s=this._pollingRequestInfoMap.get(e),o=new ts("longPollingAVError"),r=s?s.key+"-"+s.startSeq:"requestInfo is undefined";o.setMessage(`${e}-${r}-`+t.errorInfo).setCode(t.errorCode).end(!0)}else this.checkJoinedAVChatRoomByID(e)&&(Fe(s)&&Oe(o)&&this._pollingRequestInfoMap.set(e,{key:s,startSeq:o}),Oe(n)&&n>this._startBroadcastSeq&&(this._startBroadcastSeq=n),Ve(r)&&0<r.length?(r.forEach(e=>{e.to=e.groupID}),this.onMessage(r,e)):(this._pollingNoMessageCount+=1,this._pollingNoMessageCount===this.DEFAULT_POLLING_NO_MESSAGE_COUNT&&(this._pollingInterval=this.DEFAULT_POLLING_INTERVAL+this.DEFAULT_POLLING_INTERVAL_PLUS)),this._onBroadcastMessage(a))}_handleFailure(e,t){}onMessage(n,a){if(Ve(n)&&0!==n.length){let t=this._n+".onMessage",s=(a&&(t+=" groupID:"+a),0!==this._pollingNoMessageCount&&(this._pollingNoMessageCount=0,this._pollingInterval=this.DEFAULT_POLLING_INTERVAL),null);const l=[],g=this._get(o),c=this._get(u),m=n.length;1<m&&n.sort((e,t)=>e.sequence-t.sequence);var p=this._get(r).isUnlimitedAVChatRoom();let i=!1;if(lt.getLevel()<=0){const a=n.map(e=>e.sequence);lt.l(`${t} count:${a.length} sequenceList:`+a),a.length=0}for(let e=0;e<m;e++){const a=this.restoreMessageFromSimplified(n[e]);if($o[a.event]){if(6===a.event){if(this._grpM.isGroupAttributesUpdatedNotice(a))continue;if(this._grpM.isGroupCountersNotice(a))continue}if(20!==a.event)if(21!==a.event)if(100!==a.event){s=this.packMessage(a,a.event);const r=1===a.isModified;if(i=1===a.isHistoryMessage,!p){if(this.sequencesLinkedList.has(s.sequence))continue;this.sequencesLinkedList.set(s.sequence)}const u=this.messageIDLinkedList.has(s.ID);if(u)lt.w(`${t} ID:${s.ID} has:`+u);else{this.messageIDLinkedList.set(s.ID);let e=!1;if(!i&&this._isMessageSentByCurrentInstance(s)?r&&(e=!0,s.isModified=r,g.updateMsgIsModifiedProp(s)):e=!0,e){if(s.conversationType===ue&&5===s.payload.operationType&&this._onGroupDismissed(s.payload.groupProfile.groupID),!i&&s.conversationType!==ue){const n=s.conversationID.replace(ne,"");this._pollingInstanceMap.has(n)?this._grpM.isLoggedIn()&&c.addMessageSequence({key:Yt,message:s}):(s.type!==Y&&0<s.clientTime&&c.addMessageDelay(s.clientTime),c.addMessageSequence({key:Xt,message:s}))}l.push(s)}}}else this.onRoomCustomData(a);else this._get(h).onMessageReactionNotify({event:21,dataList:a.elements.messageReactionNotifyList});else this.handleMessageRevokedNotice(a)}else lt.w(t+". unknown event:"+a.event)}if(0!==l.length){a=Ye(l);if(0<a.length&&this._grpM.emitOEvt(kt,a),!i){const n=this.packConversationOption(l);0<n.length&&g.onNewMessage({conversationOptionsList:n,isInstantMessage:!0})}this._checkMessageStacked(l);a=Qe(l);0<a.length&&this._grpM.emitOEvt(qt,a),l.length=0}}}handleMessageRevokedNotice(e){const{groupID:r,elements:{revokeMsgList:t},revokerInfo:i}=e,n=[];t.forEach(e=>{var{tinyID:e,clientTime:t,random:s,sequence:o}=e,e={conversationID:""+ne+r,ID:e+`-${t}-`+s,revoker:i.revoker,revokeReason:i.reason||"",revokerInfo:{userID:i.revoker,nick:"",avatar:""},sequence:o};n.push(e)}),0!==n.length&&this._get(o).updateRevokerInfo(n).then(e=>{this._grpM.emitOEvt(Ot,e)})}isBroadcastOrNormal(e){return 3===e||17===e}isGroupTip(e){return 4===e||6===e}isGroupSystemNotice(e){return 5===e}restoreGroupTipElements(e={}){const{operatorInfo:t={},operatorID:s,userIDList:o=[],operationType:r}=e;Oe(e.groupJoinType)||1!==r&&2!==r||(e.groupJoinType=2===r?0:1);var{userID:i=s,avatar:n="",nick:a=""}=t,i=(e.operatorInfo={userID:i,avatar:n,nick:a},o.map(e=>({userID:e})));return e.memberInfoList=e.memberInfoList||i,e}restoreMessageFromSimplified(s){const e=s["event"];if(this.isBroadcastOrNormal(e)&&(s.cloudCustomData=s.cloudCustomData||"",s.elements=s.elements.map(e=>{var t;return e.type===Z&&({content:t={}}=e,e.content={data:"",description:"",extension:"",...t}),e})),(this.isGroupTip(e)||this.isGroupSystemNotice(e))&&(s.from=s.from||"@TIM#SYSTEM"),this.isGroupTip(e)){s.elements=this.restoreGroupTipElements(s.elements);const{elements:e={}}=s,{operationType:t,operatorInfo:r={}}=e;if(1===t){const s=[{userID:r.userID}];e.memberInfoList=e.memberInfoList||s}}if(this.isGroupSystemNotice(e)){let{memberInfoList:e,operatorInfo:t={}}=s.elements;e=e||t,s.elements.memberInfoList={userID:s.elements.operatorID,avatar:"",nick:"",...e},s.elements={authentication:"",remarkInfo:"",messageKey:1e3*s.time,...s.elements};var o=Object.keys(s.elements).filter(e=>"operatorInfo"!==e).reduce((e,t)=>({...e,[t]:s.elements[t]}),{});s.elements=o}return s}_onGroupDismissed(e){lt.l(this._n+"._onGroupDismissed groupID:"+e),this._grpM.deleteLocalGroupAndConversation(e),this.reset(e)}_checkMessageStacked(e){var t="MessageStacked",e=e.length;100<=e&&(this._grpM.warn(t,e),this._reportMessageStackedCount<5)&&(new ts(t).setMessage(`count:${e} groupID:`+[...this._joinedGroupMap.keys()]).setLevel("warning").end(),this._reportMessageStackedCount+=1)}_isMessageSentByCurrentInstance(e){return!!this._get(o).isMessageSentByCurrentInstance(e)}packMessage(e,t){e.currentUser=this._grpM.getMyUserID(),e.conversationType=5===t?ue:ne,e.isSystemMessage=!!e.isSystemMessage;const s=new go(e),o=this.packElements(e,t);return s.setElement(o,this._grpM.getFileDownloadProxy()),s}packElements(e,t){return 4===t||6===t?(this._updateMemberCountByGroupTips(e),{type:Y,content:{...e.elements,groupProfile:e.groupProfile}}):5===t?{type:Q,content:{...e.elements,groupProfile:{...e.groupProfile,groupID:e.groupID}}}:e.elements}packConversationOption(t){const s=new Map;for(let e=0;e<t.length;e++){var o=t[e],r=o.conversationID;if(s.has(r)){const t=s.get(r);"in"===(t.lastMessage=o).flow&&t.unreadCount++}else s.set(r,{conversationID:o.conversationID,unreadCount:"out"===o.flow?0:1,type:o.conversationType,subType:o.conversationSubType,lastMessage:o})}return[...s.values()]}_updateMemberCountByGroupTips(e){var{groupProfile:{groupID:e},elements:{onlineMemberInfo:t}}=e;if(Ue(t))return;const{onlineMemberNum:s=0,expireTime:o=this.DEFAULT_EXPIRE_TIME}=t,r=this._onlineMemberCountMap.get(e)||{},i=Date.now();Ue(r)?Object.assign(r,{lastReqTime:0,lastSyncTime:0,latestUpdateTime:i,memberCount:s,expireTime:o}):(r.latestUpdateTime=i,r.memberCount=s),this._onlineMemberCountMap.set(e,r)}_onBroadcastMessage(s){if(!Ue(s)){const o=[],r=s.length;let t=null;for(let e=0;e<r;e++){const r=this.restoreMessageFromSimplified(s[e]);$o[r.event]?((t=this.packMessage(r,r.event)).isBroadcastMessage=!0,this._broadcastMessageIDMap.has(t.ID)||(o.push(t),this._broadcastMessageIDMap.set(t.ID,1))):lt.w(this._n+"._onBroadcastMessage unknown event:"+r.event)}0<o.length&&this._grpM.emitOEvt(qt,o)}}start(e){if(this._pollingInstanceMap.has(e)){const t=this._pollingInstanceMap.get(e);void(t.isRunning()||t.start())}else{const t=new Ao({manager:this,groupID:e,onInit:this._updatedata.bind(this),onSuccess:this._handleSuccess.bind(this),onFail:this._handleFailure.bind(this)});t.start(),this._pollingInstanceMap.set(e,t),lt.l(this._n+".start groupID:"+e)}}handleJoinResult(o){return this._preCheck(o.group).then(()=>{var{longPollingKey:e,group:t}=o,s=t.groupID;return this._joinedGroupMap.set(s,t),this._grpM.updateGroupMap([t]),this._grpM.deleteUnjoinedAVChatRoom(s),this._grpM.emitGroupListUpdate(!0,!1),He(e)?Kt({status:Pe,group:t}):Promise.resolve()})}startRunLoop(r){return this.handleJoinResult(r).then(()=>{var{longPollingKey:e,group:t,startSeq:s=0}=r,o=t.groupID;return this._pollingRequestInfoMap.set(o,{key:e,startSeq:s}),this.start(o),this._grpM.isLoggedIn()?Kt({status:Pe,group:t}):Kt({status:Pe})})}_preCheck(e){if(this._get(r).isUnlimitedAVChatRoom())return Promise.resolve();if(!this.hasJoinedAVChatRoom())return Promise.resolve();if(e.type===de)return Promise.resolve();var[e,t]=this._joinedGroupMap.entries().next().value;if(this._grpM.isLoggedIn()){if(t.selfInfo.role!==_e&&t.ownerID!==this._grpM.getMyUserID())return this._grpM.quitGroup(e);this._grpM.deleteLocalGroupAndConversation(e)}else this._grpM.deleteLocalGroupAndConversation(e);return this.reset(e),Promise.resolve()}joinWithoutAuth(e){const s=e["groupID"],r=this._n+".joinWithoutAuth",n=new ts("joinWithoutAuth");return this._grpM.req({P:ps,data:e}).then(({data:{longPollingKey:e}})=>{if(n.setMessage(`groupID:${s} longPollingKey:`+e).end(!0),He(e))return Jt({code:bt});lt.l(r+" ok. groupID:"+s),this._get(o).setCompleted(""+ne+s);var t=new Ro({groupID:s});return this.startRunLoop({group:t,longPollingKey:e}),ct({status:Pe})}).catch(e=>(lt.e(r+` failed. groupID:${s} error:`,e),n.setError(e).setMessage("groupID:"+s).end(!0),Jt(e))).finally(()=>{this._grpM.get(i).reportAtOnce()})}getGroupOnlineMemberCount(e){const t=this._onlineMemberCountMap.get(e)||{},s=Date.now();return Ue(t)||s-t.lastSyncTime>1e3*t.expireTime&&1e4<s-t.latestUpdateTime&&3e3<s-t.lastReqTime?(t.lastReqTime=s,this._onlineMemberCountMap.set(e,t),this._getGroupOnlineMemberCount(e).then(e=>ct({memberCount:e.memberCount})).catch(e=>Jt(e))):Kt({memberCount:t.memberCount})}_getGroupOnlineMemberCount(r){const i=this._n+"._getGroupOnlineMemberCount",t=new ts("_getGroupOnlineMemberCount");return this._grpM.requestOnlineCount(r).then(e=>{const t=this._onlineMemberCountMap.get(r)||{},{memberCount:s=0,expireTime:o=this.DEFAULT_EXPIRE_TIME}=e.data;lt.l(i+` ok. groupID:${r} memberCount:${s} expireTime:`+o);e=Date.now();return Ue(t)&&(t.lastReqTime=e),this._onlineMemberCountMap.set(r,Object.assign(t,{lastSyncTime:e,latestUpdateTime:e,memberCount:s,expireTime:o})),{memberCount:s}}).catch(e=>(lt.w(i+" failed. error:",e),t.setCode(e.code).setMessage(`groupID:${r} error:`+JSON.stringify(e)).end(),Promise.reject(e)))}_get(e){return this._grpM.get(e)}setPollingInterval(e){He(e)||(Oe(e)?this._pollingInterval=this.DEFAULT_POLLING_INTERVAL=e:this._pollingInterval=this.DEFAULT_POLLING_INTERVAL=parseInt(e,10))}setPollingIntervalPlus(e){He(e)||(Oe(e)?this.DEFAULT_POLLING_INTERVAL_PLUS=e:this.DEFAULT_POLLING_INTERVAL_PLUS=parseInt(e,10))}setPollingNoMessageCount(e){He(e)||(Oe(e)?this.DEFAULT_POLLING_NO_MESSAGE_COUNT=e:this.DEFAULT_POLLING_NO_MESSAGE_COUNT=parseInt(e,10))}setPollingSimplifiedMessage(e){He(e)||"0"!==e&&"1"!==e||(this.DEFAULT_POLLING_SIMPLIFIED_MSG=parseInt(e,10))}getPollingInterval(){return this._pollingInterval}onAVChatRoomMemberBanned(e){e=e.payload.groupProfile.groupID;lt.l(this._n+".onAVChatRoomMemberBanned groupID:"+e),this._grpM.deleteLocalGroupAndConversation(e),this.reset(e)}restartPolling(){lt.l(this._n+".restartPolling count:"+this._pollingInstanceMap.size);for(const e of this._pollingInstanceMap.values())e.stop(),e.start()}getPollingTimerID(e){if(!this._pollingInstanceMap.has(e))return-1;var t=this._pollingInstanceMap.get(e).getPollingTimerID();return lt.l(this._n+`.getPollingTimerID groupID:${e} timerID:`+t),t}hasPollingInstance(e){return this._pollingInstanceMap.has(e)}onRoomCustomData(e){var{groupID:e,sequence:t,time:s,elements:o}=e,o=o&&o.content;this._get(c).onRoomCustomDataReceived(o),lt.l(this._n+`.onRoomCustomData groupID:${e} sequence:${t} time:${s} data:`+o)}reset(e){if(e){lt.l(this._n+".reset groupID:"+e);const t=this._pollingInstanceMap.get(e);t&&t.stop(),this._pollingInstanceMap.delete(e),this._joinedGroupMap.delete(e),this._pollingRequestInfoMap.delete(e),this._onlineMemberCountMap.delete(e)}else{lt.l(this._n+".reset all");for(const e of this._pollingInstanceMap.values())e.stop();this._pollingInstanceMap.clear(),this._joinedGroupMap.clear(),this._pollingRequestInfoMap.clear(),this._onlineMemberCountMap.clear(),this._broadcastMessageIDMap.clear()}this.sequencesLinkedList.reset(),this.messageIDLinkedList.reset(),this._reportMessageStackedCount=0,this._pollingInterval=this.DEFAULT_POLLING_INTERVAL=300,this.DEFAULT_POLLING_NO_MESSAGE_COUNT=20,this.DEFAULT_POLLING_INTERVAL_PLUS=2e3,this._pollingNoMessageCount=0}}class wo{constructor(e){this.userID="",this.avatar="",this.nick="",this.role="",this.joinTime="",this.lastSendMsgTime="",this.nameCard="",this.muteUntil=0,this.memberCustomField=[],this.isOnline=!1,this.updateMember(e)}updateMember(e){He(e.onlineStatus)||(this.isOnline="Online"===e.onlineStatus);var t=[null,void 0,"",0,NaN];e.memberCustomField&&Xe(this.memberCustomField,e.memberCustomField),Ke(this,e,["memberCustomField","marks","onlineStatus"],t)}updateRole(e){["Owner","Admin","Member"].indexOf(e)<0||(this.role=e)}updateMuteUntil(e){He(e)||(this.muteUntil=Math.floor((Date.now()+1e3*e)/1e3))}updateNameCard(e){He(e)||(this.nameCard=e)}updateMemberCustomField(e){e&&Xe(this.memberCustomField,e)}}class Uo{constructor(e){this._grpM=e,this._n="GroupMemberHandler",this.groupMemberListMap=new Map,this.DEFAULT_MEMBER_INFO_FILTER=["Role","JoinTime","NameCard","ShutUpUntil","OnlineStatus"],this._grpM.getIEmitInst().on(Wt.PROFILE_UPDATED,this._onProfileUpdated,this)}_onProfileUpdated({data:t}){for(let e=0;e<t.length;e++){const s=t[e];this.groupMemberListMap.forEach(e=>{e.has(s.userID)&&e.get(s.userID).updateMember({nick:s.nick,avatar:s.avatar})})}}deleteGroupMemberList(e){this.groupMemberListMap.delete(e)}getGroupMemberList({groupID:r,role:e,offset:s=0,count:o=15,filter:h}){const i=this._n+".getGroupMemberList",n=this._grpM.hasLocalGroup(r);if(lt.l(i+` groupID:${r} role:${e} offset:${s} count:${o} hasLocalGroup:`+n),!n)return Kt({memberList:[],offset:0});if(this._grpM.getLocalGroupProfile(r).type===he){if(this._grpM.canIUse(M.AV_MBR_LIST))return this._getAVChatRoomMemberList({groupID:r,offset:s,filter:h});this._grpM.warn("LiveOnlineMember")}let a;e!==fe&&e!==_e&&e!==Me||(a=e);const g=new ts("getGroupMemberList");let u=0;const p={groupID:r,limit:100<o?100:o,memberRoleFilter:a?[a]:void 0,memberInfoFilter:this.DEFAULT_MEMBER_INFO_FILTER};et({groupID:r})?p.next=""+s:(p.offset=s,u=s+o);let l=[];return this._grpM.req({P:Os,data:p}).then(({data:{members:e,memberNum:s,next:o}})=>(He(o)||(u=Ue(o)?0:o),Ve(e)&&0!==e.length?(this._grpM.hasLocalGroup(r)&&(this._grpM.getLocalGroupProfile(r).memberNum=s),l=this._updateLocalGroupMemberMap(r,e),this._grpM.get(t).getUserProfile({userIDList:e.map(e=>e.userID),tagList:[Se.NICK,Se.AVATAR]})):(u=0,Promise.resolve([])))).then(e=>{const t=e["data"];if(!Ve(t)||0===t.length)return Kt({memberList:[],offset:u});e=t.map(e=>({userID:e.userID,nick:e.nick,avatar:e.avatar}));return this._updateLocalGroupMemberMap(r,e),l.length<o&&(u=0),g.setMessage(`groupID:${r} offset:${s} count:`+o).end(),lt.l(i+" ok."),ct({memberList:l,offset:u})}).catch(e=>(g.setError(e).end(),lt.e(i+" failed. error:",e),Jt(e)))}_getAVChatRoomMemberList({groupID:o,offset:e,filter:t}){const r=this._n+"._getAVChatRoomMemberList",i=new ts("_getAVChatRoomMemberList");return i.setMessage(`groupID:${o} offset:${e} filter:`+t),this._grpM.req({P:Fs,data:{groupID:o,offset:e,filter:t}}).then(e=>{const{memberList:t=[],offset:s=0}=e.data;i.end(),lt.l(r+` ok. member count:${t.length}, next request timestamp:`+s);e=t.map(e=>({...e,onlineStatus:"Online"})),e=this._updateLocalGroupMemberMap(o,e);return ct({memberList:e,offset:s})}).catch(e=>(i.setError(e).end(),lt.e(r+" failed. error:",e),Jt(e)))}getGroupMemberProfile(e){var s="getGroupMemberProfile",o=this._n+"."+s;let r="groupID:"+e.groupID;5<e.userIDList.length?r+=" userIDList.length:"+e.userIDList.length:r+=" userIDList:"+e.userIDList,lt.l(o+" "+r),50<e.userIDList.length&&(e.userIDList=e.userIDList.slice(0,50));const{groupID:i,userIDList:n}=e,a=this._grpM.getLocalGroupProfile(i);if(a&&Ze(a.type)){const e=$t;return Jt({code:e,message:this._grpM.getErrMsg(e,s)})}const u=new ts(s);return u.setMessage(r),this._getGroupMemberProfileAdvance({...e,userIDList:n}).then(e=>{const s=e.data["members"];return Ve(s)&&0!==s.length?(this._updateLocalGroupMemberMap(i,s),this._grpM.get(t).getUserProfile({userIDList:s.map(({userID:e})=>e),tagList:[Se.NICK,Se.AVATAR]})):Kt([])}).then(e=>{e=e.data.map(({userID:e,nick:t,avatar:s})=>({userID:e,nick:t,avatar:s})),this._updateLocalGroupMemberMap(i,e),e=n.filter(e=>this.hasLocalGroupMember(i,e)).map(e=>this.getLocalGroupMemberInfo(i,e));return u.end(),ct({memberList:e})})}addGroupMember(i){const n=this._n+".addGroupMember",e=i["groupID"],a=this._grpM.getLocalGroupProfile(e),t=a["type"],u=new ts("addGroupMember");if(u.setMessage(`groupID:${e} groupType:`+t),Ze(t)){const i=new ht({code:Ct});return u.setError(i).end(),Jt(i)}return i.userIDList=i.userIDList.map(e=>({userID:e})),lt.l(n+" groupID:"+e),this._grpM.req({P:Vs,data:i}).then(({data:{members:e}})=>{lt.l(n+" ok");var t=e.filter(e=>1===e.result).map(e=>e.userID),s=e.filter(e=>0===e.result).map(e=>e.userID),o=e.filter(e=>2===e.result).map(e=>e.userID),e=e.filter(e=>4===e.result).map(e=>e.userID),r=`groupID:${i.groupID}, successUserIDList:${t}, failureUserIDList:${s}, existedUserIDList:${o}, overLimitUserIDList:`+e;return u.setMoreMessage(r).end(),0===t.length?ct({successUserIDList:t,failureUserIDList:s,existedUserIDList:o,overLimitUserIDList:e}):(this._updateConvGroupProfile(a),ct({successUserIDList:t,failureUserIDList:s,existedUserIDList:o,overLimitUserIDList:e,group:a}))}).catch(e=>(u.setError(e).end(),lt.e(n+" failed. error:",e),Jt(e)))}deleteGroupMember(e){const t=this._n+".deleteGroupMember",{groupID:s,userIDList:o}=e,r=this._grpM.getLocalGroupProfile(s);if(He(r))return Jt({code:Mt});if(Ze(r.type))return this._grpM.canIUse(M.AV_BAN_MBR)?this._banAVChatRoomMember(e):this._grpM.noUse("deleteGroupMember");var i=`groupID:${s} `+(5<o.length?"userIDList.length:"+o.length:"userIDList:"+o);lt.l(t+` groupID:${s} userIDList:`,o);const n=new ts("deleteGroupMember");return n.setMessage(i),this._grpM.req({P:Hs,data:e}).then(()=>(n.end(),lt.l(t+" ok"),this._updateConvGroupProfile(r),this.deleteLocalGroupMembers(s,o),ct({group:r,userIDList:o}))).catch(e=>(n.setError(e).end(),lt.e(t+" failed. error:",e),Jt(e)))}_updateConvGroupProfile(e){this._grpM.get(o).updateConvGroupProfile([e])}_banAVChatRoomMember(e){const t=this._n+"._banAVChatRoomMember",{groupID:s,userIDList:o}=e,r=`groupID:${s} `+(5<o.length?"userIDList.length:"+o.length:"userIDList:"+o),i=new ts("_banAVChatRoomMember"),n=(i.setMessage(r),lt.l(t+` groupID:${s} userIDList:`,o),this._grpM.getLocalGroupProfile(s));return He(e.duration)||0===e.duration?Jt({code:Rt}):this._grpM.req({P:js,data:e}).then(()=>(i.end(),lt.l(t+" ok"),this.deleteLocalGroupMembers(s,o),ct({group:n,userIDList:o}))).catch(e=>(i.setError(e).end(),lt.e(t+" failed. error:",e),Jt(e)))}setGroupMemberMuteTime(e){const{groupID:s,userID:t,muteTime:o}=e,r=this._n+".setGroupMemberMuteTime";if(t===this._grpM.getMyUserID())return Jt({code:Pt});e=`groupID:${s} userID:${t} muteTime:`+o;lt.l(r+" "+e);const i=new ts("setGroupMemberMuteTime");return i.setMessage(e),this.modifyGroupMemberInfo({groupID:s,userID:t,muteTime:o}).then(e=>{i.end(),lt.l(r+" ok");var t=this._grpM.getLocalGroupProfile(s);return ct({group:t,member:e})}).catch(e=>(i.setError(e).end(),lt.e(r+" failed. error:",e),Jt(e)))}setGroupMemberRole(e){const t=this._n+".setGroupMemberRole",{groupID:s,userID:o,role:r}=e,i=`groupID:${s} userID:${o} role:`+r,n=this._grpM.getLocalGroupProfile(s);if(!n||n.type===pe||n.type===he)return Jt({code:At});if(n&&n.selfInfo.role!==_e)return Jt({code:Tt});const a=[fe,Me];if(et({groupID:s})&&a.push(Ie),a.indexOf(r)<0)return Jt({code:vt});if(o===this._grpM.getMyUserID())return Jt({code:St});const u=new ts("setGroupMemberRole");return u.setMessage(i),lt.l(t+" "+i),this.modifyGroupMemberInfo({groupID:s,userID:o,role:r}).then(e=>(u.end(),lt.l(t+" ok"),ct({group:n,member:e}))).catch(e=>(u.setError(e).end(),lt.e(t+" failed. error:",e),Jt(e)))}_filterProfanity(e,t){const s=this._grpM.get(l);if(!s)return!0;var{isAllowedToSend:o,modifiedText:r}=s.filterText(t[e],D);return!0===o&&(t[e]=r,!0)}setGroupMemberNameCard(e){const t="setGroupMemberNameCard",s=this._n+"."+t;if(e.nameCard&&!1===this._filterProfanity("nameCard",e))return Jt({code:Nt});const{groupID:o,userID:r=this._grpM.getMyUserID(),nameCard:i}=e,n=`groupID:${o} userID:${r} nameCard:`+i;lt.l(s+" "+n);e=this._grpM.getLocalGroupProfile(o);if(e&&Ze(e.type)){const e=$t;return Jt({code:e,message:this._grpM.getErrMsg(e,t)})}const a=new ts(t);return a.setMessage(n),this.modifyGroupMemberInfo({groupID:o,userID:r,nameCard:i}).then(e=>{lt.l(s+" ok"),a.end();const t=this._grpM.getLocalGroupProfile(o);return r===this._grpM.getMyUserID()&&t&&t.setSelfNameCard(i),ct({group:t,member:e})}).catch(e=>(a.setError(e).end(),lt.e(s+" failed. error:",e),Jt(e)))}setGroupMemberCustomField(e){const t="setGroupMemberCustomField",s=this._n+"."+t,{groupID:o,userID:r=this._grpM.getMyUserID(),memberCustomField:i}=e,n=`groupID:${o} userID:${r} memberCustomField:`+JSON.stringify(i);lt.l(s+" "+n);e=this._grpM.getLocalGroupProfile(o);if(e&&Ze(e.type)){const e=$t;return Jt({code:e,message:this._grpM.getErrMsg(e,t)})}const a=new ts(t);return a.setMessage(n),this.modifyGroupMemberInfo({groupID:o,userID:r,memberCustomField:i}).then(e=>{a.end(),lt.l(s+" ok");var t=this._grpM.getLocalGroupProfile(o);return ct({group:t,member:e})}).catch(e=>(a.setError(e).end(),lt.e(s+" failed. error:",e),Jt(e)))}modifyGroupMemberInfo(t){let{groupID:s,userID:o}=t,e=void 0;return st(s)&&(s=ot(e=s)),this._grpM.req({P:Bs,data:{...t,groupID:s,topicID:e}}).then(()=>{if(this.hasLocalGroupMember(s,o)){const e=this.getLocalGroupMemberInfo(s,o);return He(t.muteTime)||e.updateMuteUntil(t.muteTime),He(t.role)||e.updateRole(t.role),He(t.nameCard)||e.updateNameCard(t.nameCard),He(t.memberCustomField)||e.updateMemberCustomField(t.memberCustomField),e}const e=this._grpM.getLocalGroupProfile(s);if(e&&!Ze(e.type))return this.getGroupMemberProfile({groupID:s,userIDList:[o]}).then(({data:{memberList:[e]}})=>e)})}markGroupMemberList(l){const r=this._n+".markGroupMemberList",{groupID:e,markType:t,enableMark:s,userIDList:i=[]}=l,o=`groupID:${e} markType:${t} enableMark:${s} userIDList count:`+i.length;lt.l(r+" "+o);let n=2;const a=[];!0===s&&(n=1);let u=[...i];500<i.length&&(u=i.slice(0,500),lt.w(r+" "+"the length of userIDList cannot exceed 500")),u.forEach(e=>{a.push({userID:e,markType:[t]})}),u=null;const p=new ts("markGroupMemberList");return p.setMessage(o),this._grpM.req({P:Ks,data:{groupID:e,operationType:n,memberList:a}}).then(e=>{const{memberList:t=[]}=e.data,s=[],o=[];t.length===i.length?s.push(...i):(t.forEach(e=>{s.push(e.userID)}),i.forEach(e=>{s.includes(e)||o.push(e)}));e=`success count:${s.length} fail count:`+o.length;return p.setMessage(e).end(),lt.l(r+" ok. "+e),ct({successUserIDList:s,failureUserIDList:o})}).catch(e=>(p.setError(e).end(),lt.e(r+" failed. error:",e),Jt(e)))}_getGroupMemberProfileAdvance(e){return this._grpM.req({P:xs,data:{...e,memberInfoFilter:e.memberInfoFilter||this.DEFAULT_MEMBER_INFO_FILTER}})}_updateLocalGroupMemberMap(t,e){return Ve(e)&&0!==e.length?e.map(e=>(this.hasLocalGroupMember(t,e.userID)?this.getLocalGroupMemberInfo(t,e.userID).updateMember(e):this.setLocalGroupMember(t,new wo(e)),this.getLocalGroupMemberInfo(t,e.userID))):[]}deleteLocalGroupMembers(e,t){const s=this.groupMemberListMap.get(e);s&&t.forEach(e=>{s.delete(e)})}getLocalGroupMemberInfo(e,t){return this.groupMemberListMap.has(e)?this.groupMemberListMap.get(e).get(t):null}setLocalGroupMember(e,t){this.groupMemberListMap.has(e)?this.groupMemberListMap.get(e).set(t.userID,t):(t=(new Map).set(t.userID,t),this.groupMemberListMap.set(e,t))}getLocalGroupMemberList(e){return this.groupMemberListMap.get(e)}hasLocalGroupMember(e,t){return this.groupMemberListMap.has(e)&&this.groupMemberListMap.get(e).has(t)}hasLocalGroupMemberMap(e){return this.groupMemberListMap.has(e)}reset(){this.groupMemberListMap.clear()}}function No(e){var t=e.lastIndexOf(".");return-1===t?e:e.slice(0,t)}function qo(e){var{androidInfo:e={},androidOPPOChannelID:t=""}=e,t=e.OPPOChannelID||t;return{...e,Sound:No(e.sound||""),OPPOChannelID:t,GoogleChannelID:e.FCMChannelID||""}}function ko(e){var{apnsInfo:e={},ignoreIOSBadge:t=!1,disableVoipPush:s}=e,t=!0===e.ignoreIOSBadge||!0===t?1:0;let o=void 0;return He(s)||(o=!1===s?1:0),He(e.disableVoipPush)||(o=!1===e.disableVoipPush?1:0),{...e,badgeMode:t,isVoipPush:o}}function Oo(e){if(xe(e))return{pushFlag:!0===e.disablePush?1:0,title:e.title||"",desc:e.description||"",ext:e.extension||"",apnsInfo:ko(e),androidInfo:qo(e)}}const Fo=1,xo=15;class Vo{constructor(e){this._grpM=e,this._n="GroupSystemNoticeHandler",this.pendencyMap=new Map}onNewGroupSystemNotice(e){var{dataList:e,isSyncingEnded:t,isInstantMessage:s}=e,{eventDataList:e,result:r}=(lt.d(this._n+".onReceiveSystemNotice count:"+e.length),this._assembly({notifiesList:e,isInstantMessage:s}));0<e.length&&(this._grpM.get(o).onNewMessage({conversationOptionsList:e,isInstantMessage:s}),this._onReceivedGroupSystemNotice({result:r,isInstantMessage:s})),s?0<r.length&&this._grpM.emitOEvt(qt,r):!0===t&&this._clearGroupSystemNotice()}_assembly({notifiesList:e,isInstantMessage:h}){let t=null;const s=e.length;let r=0;const i=[],n={conversationID:ue,unreadCount:0,type:ue,subType:null,lastMessage:null};for(r=0;r<s;r++){const s=e[r],{groupProfile:{communityType:a=0,topicID:u},elements:{topicIDList:p,operationType:l}}=s;if(!(2!==a||Ue(u)&&Ue(p))){if([17,18,20].includes(l)){this._handleTopicSystemNotice(s);continue}Ue(u)||(s.to=u)}s.elements.operationType!==xo&&(s.currentUser=this._grpM.getMyUserID(),s.conversationType=ue,s.conversationID=ue,(t=new go(s)).setElement({type:Q,content:{...s.elements,groupProfile:{...s.groupProfile}}}),t.isSystemMessage=!0,(1===t.sequence&&1===t.random||2===t.sequence&&2===t.random)&&(t.sequence=Je(),t.random=Je(),t.generateMessageID(),lt.l(this._n+"._assembly regenerate ID:"+t.ID)),this._grpM.get(o).pushIntoNoticeResult(i,t)&&(h?n.unreadCount++:t.setIsRead(!0),n.subType=t.conversationSubType))}return n.lastMessage=i[i.length-1],{eventDataList:0<i.length?[n]:[],result:i}}_clearGroupSystemNotice(){this._getPendencyList().then(e=>{e.forEach(e=>{this.pendencyMap.set(`${e.from}_${e.groupID}_`+e.to,e)});const t=this._grpM.get(o).getLocalMessageList(ue),i=[];t.forEach(e=>{const{operatorID:t,operationType:s,groupProfile:o}=e.payload;if(s===Fo){const s=`${t}_${o.groupID}_`+o.to,r=this.pendencyMap.get(s);r&&Oe(r.handled)&&0!==r.handled&&i.push(e)}}),this.deleteGroupSystemNotice({messageList:i})})}deleteGroupSystemNotice(e){const s=this._n+".deleteGroupSystemNotice";return Ve(e.messageList)&&0!==e.messageList.length?(lt.l(s+" "+e.messageList.map(e=>e.ID)),this._grpM.req({P:Gs,data:{messageListToDelete:e.messageList.map(e=>({from:ue,messageSeq:e.clientSequence,messageRandom:e.random}))}}).then(()=>{lt.l(s+" ok");const t=this._grpM.get(o);return e.messageList.forEach(e=>{t.deleteLocalMessage(e)}),ct()}).catch(e=>(lt.e(s+" error:",e),Jt(e)))):Kt()}_getPendencyList(e={}){var{type:e,startTime:t=0,limit:s=20}=e;return this._grpM.req({P:ys,data:{type:e,startTime:t,limit:s,handleAccount:this._grpM.getMyUserID()}}).then(e=>{const t=e.data.pendencyList;return 0!==e.data.nextStartTime?this._getPendencyList({startTime:e.data.nextStartTime}).then(e=>[...t,...e]):t})}getGroupApplicationList(){return this._getPendencyList().then(t=>this._getPendencyList({type:ge}).then(e=>(t.push(...e),this._handlePendencyResult(t))).catch(e=>this._handlePendencyResult(t)))}_handlePendencyResult(e){const t=[];return e.forEach(e=>{this.pendencyMap.set(`${e.from}_${e.groupID}_`+e.to,e),0===e.handled&&t.push({applicant:e.from,applicantNick:e.fromUserNickName,groupName:e.groupName,groupID:e.groupID,authentication:e.authentication,messageKey:e.time,applicationType:e.applicationType,userID:e.userID,note:e.note})}),Kt({applicationList:t})}_onReceivedGroupSystemNotice({result:e,isInstantMessage:t}){t&&e.forEach(e=>{switch(e.payload.operationType){case 1:break;case 2:this._onApplyJoinGroup(e);break;case 3:break;case 4:this._onMemberKicked(e);break;case 5:this._onGroupDismissed(e);break;case 6:break;case 7:this._onInviteGroup(e);break;case 8:this._onQuitGroup(e);break;case 9:this._onSetManager(e);break;case 10:this._onDeleteManager(e);break;case 11:case 12:case 15:break;case 20:this._onMessageRemindTypeSynced(e);break;case 21:this._grpM.onAVChatRoomMemberBanned(e)}})}_onApplyJoinGroup(e){var{groupID:e,groupType:t}=e.payload.groupProfile,s=this._grpM.hasLocalGroup(e);lt.l(this._n+`._onApplyJoinGroup groupID:${e} groupType:${t} hasGroup:`+s),s||Ze(t)||this._grpM.getGroupProfile({groupID:e}).then(({data:{group:e}})=>{e&&(this._grpM.updateGroupMap([e]),e=!e.isSupportTopic,this._grpM.emitGroupListUpdate(!0,e))})}_onMemberKicked(e){e=e.payload.groupProfile.groupID;this._grpM.hasLocalGroup(e)&&this._grpM.deleteLocalGroupAndConversation(e)}_onGroupDismissed(e){e=e.payload.groupProfile.groupID;this._grpM.hasLocalGroup(e)&&this._grpM.deleteLocalGroupAndConversation(e);const t=this._grpM["_AVChatRoomHandler"];t&&t.checkJoinedAVChatRoomByID(e)&&t.reset(e)}_onInviteGroup(e){const t=e.payload.groupProfile.groupID,s=this._grpM.hasLocalGroup(t);lt.l(`${this._n}._onInviteGroup groupID:${t} hasGroup:`+s),this._grpM.getGroupProfile({groupID:t}).then(()=>{this._grpM.emitGroupListUpdate(),this._grpM.get(o).recoverMessageOnInviteGroup(""+ne+t)})}_onQuitGroup(e){var{groupID:e,groupType:t}=e.payload.groupProfile,s=this._grpM.hasLocalGroup(e);lt.l(this._n+`._onQuitGroup groupID:${e} groupType:${t} hasGroup:`+s),s&&this._grpM.deleteLocalGroupAndConversation(e)}_onSetManager(e){const{to:t,groupID:s}=e.payload.groupProfile,o=this._grpM.getGroupMemberHandler().getLocalGroupMemberInfo(s,t);o&&o.updateRole(fe)}_onDeleteManager(e){const{to:t,groupID:s}=e.payload.groupProfile,o=this._grpM.getGroupMemberHandler().getLocalGroupMemberInfo(s,t);o&&o.updateRole(Me)}_onMessageRemindTypeSynced(e){var t=e.payload.groupProfile["groupID"],e=e.payload.messageRemindType;this._grpM.get(o).onGroupMsgRemindTypeUpdated({groupID:t,messageRemindType:e})}_handleTopicSystemNotice(e){const{groupProfile:{groupID:t,topicID:o},elements:{operationType:r,topicIDList:i,messageRemindType:n}}=e,a=this._grpM.get(s);17===r?a.onTopicCreated({groupID:t,topicID:o}):18===r?a.onTopicDeleted({groupID:t,topicIDList:i}):20===r&&a.onTopicMessageRemindTypeUpdated({groupID:t,topicID:o,messageRemindType:n})}reset(){this.pendencyMap.clear()}}class Ho extends class{constructor(e){this._m=e,this._n=""}isLoggedIn(){return this._m.get(r).isLoggedIn()}isOversea(){return this._m.get(r).isOversea()}isPrivateNetWork(){return this._m.get(r).isPrivateNetWork()}getFileDownloadProxy(){return this._m.get(r).getFileDownloadProxy()}getMyUserID(){return this._m.get(r).getUserID()}getMyTinyID(){return this._m.get(r).getTinyID()}getSDKAppID(){return this._m.get(r).getSDKAppID()}isIntl(){return this._m.get(r).isIntl()}isUsingChatCore(){return this._m.get(r).isUsingChatCore()}isDevMode(){return this._m.get(r).isDevMode()}get(e){return this._m.get(e)}getPlatform(){return N}getCloudConfig(e){return this._m.get(a).getCloudConfig(e)}emitOEvt(e,t){this._m.getOEmitInst().emit(e,t)}emitIEvt(e,t){this._m.getIEmitInst().emit(e,t)}getIEmitInst(){return this._m.getIEmitInst()}generateTjgID(e){return this._m.get(r).getTinyID()+"-"+e.random}req(e){return this._m.get(n).req(e)}canIUse(e){return this._m.get(p).canIUse(e)}getErrMsg(e,t,s){return this._m.getErrMsg(e,t,s)}warn(e,t,s){e=this.getErrMsg(e,t,s);e&&lt.w(e)}noUse(e){var t=Ut;return Jt({code:t,message:this.getErrMsg(t,e)})}}{constructor(e){super(e),this._n="GroupModule",this._commonGroupHandler=new _o(this),this._groupAttributesHandler=new yo(this),this._groupCountersHandler=new To(this),this._AVChatRoomHandler=new Eo(this),this._groupTipsHandler=new mo(this),this._groupSystemNoticeHandler=new Vo(this),this._groupMemberHandler=new Uo(this),this.groupMap=new Map,this._unjoinedAVChatRoomList=new Map,this._receiptDetailCompleteMap=new Map,this._onlineMemberCountMap=new Map,this._timeoutIDs=[],this.getIEmitInst().on(Wt.CLOUD_CONFIG_UPDATED,this._onCloudConfigUpdated,this)}_onCloudConfigUpdated(){var e=this.getCloudConfig("polling_interval"),t=this.getCloudConfig("polling_interval_plus"),s=this.getCloudConfig("polling_no_msg_count"),o=this.getCloudConfig("polling_simplified_msg"),r=this.getCloudConfig("paging_grp_count");lt.l(this._n+`._onCloudConfigUpdated pollingInterval:${e} pollingIntervalPlus:${t} pollingNoMessageCount:${s} pollingSimplifiedMessage:${o} pagingGroupCount:`+r),this._AVChatRoomHandler.setPollingInterval(e),this._AVChatRoomHandler.setPollingIntervalPlus(t),this._AVChatRoomHandler.setPollingNoMessageCount(s),this._AVChatRoomHandler.setPollingSimplifiedMessage(o),this._commonGroupHandler.setPagingGroupCount(r)}onCheckTimer(e){this.isLoggedIn()&&(this._commonGroupHandler.onCheckTimer(e),this._groupTipsHandler.onCheckTimer(e))}guardForAVChatRoom(t){if(t.conversationType!==ne)return Kt();{const s=st(t.to)?ot(t.to):t.to;return this.hasLocalGroup(s)?Kt():this.getGroupProfile({groupID:s}).then(e=>{e=e.data.group.type;if(lt.l(`${this._n}.guardForAVChatRoom. groupID:${s} type:`+e),e!==he)return Kt();{const e=gt;return Jt(new ht({code:e,message:this.getErrMsg(e,t.from,s),data:{message:t}}))}})}}checkJoinedAVChatRoomByID(e){return this._AVChatRoomHandler.checkJoinedAVChatRoomByID(e)}onNewMessage(e){this._commonGroupHandler.onNewMessage(e)}updateNextMessageSeq(e){if(Ve(e)){const o=this.get(s);e.forEach(e=>{var t=e.conversationID.replace(ne,"");st(t)&&o.updateLastMessage(t,e.lastMessage),this.groupMap.has(t)&&(this.groupMap.get(t).nextMessageSeq=e.lastMessage.sequence+1)})}}onNewGroupTips(e){this._groupTipsHandler.onNewGroupTips(e)}onMsgRevoked(e){this._commonGroupHandler.onMsgRevoked(e)}onNewGroupSystemNotice(e){this._groupSystemNoticeHandler.onNewGroupSystemNotice(e)}onMsgReadNotice(e){e.dataList.forEach(i=>{const e=i.elements["groupMessageReadNotice"];if(!He(e)){const i=this.get(o);e.forEach(e=>{var{groupID:e,topicID:t,lastMessageSeq:s}=e;lt.l(this._n+`.onMsgReadNotice groupID:${e} lastMessageSeq:`+s);let o=""+ne+e,r=!0;Ue(t)||(o=""+ne+t,r=!1),i.updateIsReadAfterReadReport({conversationID:o,lastMessageSeq:s}),i.updateUnreadCount(o,r),i.clearGroupAtInfoList(o,r)})}})}onReadReceiptList(e){lt.l(this._n+".onReadReceiptList options:",e),e.dataList.forEach(e=>{const{groupProfile:t,elements:s}=e,r=t["groupID"],i=this.get(o),n=s["readReceiptList"];i.updateReadReceiptInfo({groupID:r,readReceiptList:n})})}onMsgModified(e){lt.l(this._n+".onMsgModified options:",e);const t=this.get(o);e.dataList.forEach(e=>{t.onMessageModified({...e,conversationType:ne,to:e.topicID||e.groupID})})}deleteGroupSystemNotice(e){this._groupSystemNoticeHandler.deleteGroupSystemNotice(e)}initGroupMap(e){this.groupMap.set(e.groupID,new Ro(e))}clearGroupMap(){this.groupMap.clear()}deleteGroup(e){this.groupMap.delete(e)}updateGroupMap(e){const t=this.get(o);let s;e.forEach(e=>{s=e.groupID,this.groupMap.has(s)?this.groupMap.get(s).updateGroup(e):(this.groupMap.set(s,new Ro(e)),t.deleteGroupRoamingMessageInfo(s))});var r=this.getMyUserID();for(const[,o]of this.groupMap)o.selfInfo.userID=r,"Owner"===o.selfInfo.role&&(o.ownerID=r)}getGroupMap(){return this.groupMap}getLocalGroupList(){return[...this.groupMap.values()].filter(e=>e.type!==me&&e.type!==de)}getLocalGroupProfile(e){return this.groupMap.get(e)}sortLocalGroupList(){const e=[...this.groupMap].filter(([,e])=>!Ue(e.lastMessage));e.sort((e,t)=>t[1].lastMessage.lastTime-e[1].lastMessage.lastTime),this.groupMap=new Map([...e])}updateGroupLastMessage(e){this._commonGroupHandler.updateLastMsg(e)}emitGroupListUpdate(e=!0,t=!0){var s=this.getLocalGroupList();if(e&&this.emitOEvt(Ft),t){const e=JSON.parse(JSON.stringify(s));this.get(o).updateConvGroupProfile(e)}}getMyNameCardByGroupID(e){e=this.getLocalGroupProfile(e);return e?e.selfInfo.nameCard:""}isPagingGetCompleted(){return this._commonGroupHandler.isPagingGetCompleted()}getMsgRemindType(e){!Ve(e)||0===e.length||0!==(e=e.filter(e=>!Ze(this.getLocalGroupProfile(e).type))).length&&(lt.l(this._n+".getMsgRemindType groupIDList:"+e),this.getGroupProfileAdvance({groupIDList:e,responseFilter:{memberInfoFilter:["MsgFlag"]}}).then(e=>{const t=e.data["successGroupList"],s=this.get(o);t.forEach(e=>{s.onGroupMsgRemindTypeUpdated({groupID:e.groupID,messageRemindType:Ve(e.members)?e.members[0].messageRemindType:""})})}))}getGroupList(){return this._commonGroupHandler.getGroupList()}syncCommunityWithTopic(){return this._commonGroupHandler.syncGroupList(!0)}getGroupProfile(t){const r=this._n+".getGroupProfile",i=new ts("getGroupProfile"),{groupID:n,groupCustomFieldFilter:e}=t;lt.l(r+" groupID:"+n);var s={groupIDList:[n],responseFilter:{groupBaseInfoFilter:[...L],groupCustomFieldFilter:e,memberInfoFilter:[...y,"NameCard"]}};return this.getGroupProfileAdvance(s).then(({data:{successGroupList:e,failureGroupList:t}})=>{if(lt.l(r+" ok"),0<t.length)return Jt(t[0]);let s;return(s=Ze(e[0].type)&&!this.hasLocalGroup(n)?new Ro(e[0]):(this.updateGroupMap(e),this.getLocalGroupProfile(n))).isSupportTopic||this.get(o).updateConvGroupProfile([s]),i.setMessage(`groupID:${n} type:${s.type} muteAllMembers:${s.muteAllMembers} ownerID:`+s.ownerID).end(),ct({group:s})}).catch(e=>(i.setError(e).setMessage("groupID:"+t.groupID).end(),lt.e(r+" failed. error:",e),Jt(e)))}getGroupProfileAdvance(e){const t=this._n+".getGroupProfileAdvance",s=e["groupIDList"],o=(Ve(s)&&50<s.length&&(this.warn("GetGroupProfileLimit"),s.length=50),[]),r=[],i=(s.forEach(e=>{(et({groupID:e})?r:o).push(e)}),[]);if(0<o.length){const t=this._getGroupProfileAdvance({...e,groupIDList:o});i.push(t)}if(0<r.length){const t=this._getGroupProfileAdvance({...e,groupIDList:r,relayFlag:0<o.length});i.push(t)}return Promise.all(i).then(e=>{const t=[],s=[];return e.forEach(e=>{t.push(...e.successGroupList),s.push(...e.failureGroupList)}),ct({successGroupList:t,failureGroupList:s})}).catch(e=>(lt.e(t+" failed. error:",e),Jt(e)))}_getGroupProfileAdvance(t){const{relayFlag:s=!1,...o}=t;return this.req({P:rs,data:o}).then(e=>{lt.l(this._n+"._getGroupProfileAdvance ok. options:",o);const t=e.data["groups"];return{successGroupList:t.filter(e=>He(e.errorCode)||0===e.errorCode),failureGroupList:t.filter(e=>e.errorCode&&0!==e.errorCode).map(e=>new ht({code:e.errorCode,message:e.errorInfo,data:{groupID:e.groupID}}))}}).catch(e=>s&&et({groupID:t.groupIDList[0]})?{successGroupList:[],failureGroupList:[]}:Jt(e))}createGroup(u){const s=[le,pe,ce,he,ge],p=this._n+".createGroup",{type:o,groupID:r}=u;if(u.name&&!1===this._filterProfanity("name",u))return Jt({code:Nt});if(u.introduction&&!1===this._filterProfanity("introduction",u))return Jt({code:Nt});if(u.notification&&!1===this._filterProfanity("notification",u))return Jt({code:Nt});if(!s.includes(o))return Jt({code:dt});if(!et({type:o})){if(!Ue(r)&&et({groupID:r}))return Jt({code:ft});u.isSupportTopic=void 0}if(Ze(o)&&!He(u.memberList)&&0<u.memberList.length&&(u.memberList=void 0),this._canIUseJoinOption(o)||He(u.joinOption)||(u.joinOption=void 0),et({type:o})){if(!Ue(r)&&!et({groupID:r}))return Jt({code:ft});u.isSupportTopic=!0===u.isSupportTopic?1:0}const l=new ts("createGroup");lt.l(p+" options:",u);let h=null,g=[];return this.req({P:is,data:{...u,ownerID:this.getMyUserID(),webPushFlag:1}}).then(s=>{const{groupID:o,overLimitUserIDList:r=[]}=s.data;h=o,g=r;s=`groupType:${u.type} groupID:${o} overLimitUserIDList:`+r;if(l.setMessage(s).end(),lt.l(p+" ok. "+s),u.type===he)return this.getGroupProfile({groupID:o});if(u.type===ge&&1===u.isSupportTopic)return this.getGroupProfile({groupID:o});Ue(u.memberList)||Ue(r)||(u.memberList=u.memberList.filter(e=>-1===r.indexOf(e.userID))),this.updateGroupMap([{...u,groupID:o}]);const i=this.get(e);let n="",a=0;u.type===ge?(n=this.isIntl()?"Create Community":"创建社群",a=1):n=this.isIntl()?"Create Group":"创建群组";s=this.get(t).getMyNick(),s=i.createCustomMessage({to:o,conversationType:ne,payload:{data:JSON.stringify({businessID:"group_create",content:n,cmd:a,opUser:s||this.getMyUserID(),version:4})}});return i.sendMessageInstance(s),this.emitGroupListUpdate(),this.getGroupProfile({groupID:o})}).then(e=>{const t=e.data["group"],{nameCard:s,joinTime:o}=t.selfInfo;return t.updateSelfInfo({nameCard:s,joinTime:o,messageRemindType:Ce,role:_e}),ct({group:t,overLimitUserIDList:g})}).catch(e=>{if(l.setMessage("groupType:"+u.type).setError(e).end(),10010!==e.code&&10007!==e.code)return lt.e(p+" failed. error:",e),Jt(e);{this._silentlyGetGroupProfile(e.code,h),this.updateGroupMap([{...u,groupID:h}]);const t=this.getLocalGroupProfile(h);return t.selfInfo.role=_e,ct({group:t,overLimitUserIDList:g})}})}dismissGroup(e){const t=this._n+".dismissGroup",s="groupID:"+e;if(this.hasLocalGroup(e)&&this.getLocalGroupProfile(e).type===pe)return Jt(new ht({code:Lt}));const o=new ts("dismissGroup");return o.setMessage(s),lt.l(t+" "+s),this.req({P:ns,data:{groupID:e}}).then(()=>(o.end(),lt.l(t+" ok"),this.deleteLocalGroupAndConversation(e),this.checkJoinedAVChatRoomByID(e)&&this._AVChatRoomHandler.reset(e),this._groupAttributesHandler.deleteLocalGroupAttributes(e),ct({groupID:e}))).catch(e=>(o.setError(e).end(),lt.e(t+" failed. error:",e),Jt(e)))}updateGroupProfile(e){const t=this._n+".updateGroupProfile";if(this.hasLocalGroup(e.groupID)){const s=this.getLocalGroupProfile(e.groupID).type;this._canIUseJoinOption(s)||He(e.joinOption)||(lt.w(t+" joinOption is unavailable for Work/Meeting/AVChatRoom"),e.joinOption=void 0)}if(He(e.muteAllMembers)||(e.muteAllMembers?e.muteAllMembers="On":e.muteAllMembers="Off"),e.name&&!1===this._filterProfanity("name",e))return Jt({code:Nt});if(e.introduction&&!1===this._filterProfanity("introduction",e))return Jt({code:Nt});if(e.notification&&!1===this._filterProfanity("notification",e))return Jt({code:Nt});const s=new ts("updateGroupProfile");return s.setMessage(JSON.stringify(e)),lt.l(t+" groupID:"+e.groupID),this.req({P:as,data:e}).then(()=>(s.end(),lt.l(t+" ok"),this.hasLocalGroup(e.groupID)&&this.groupMap.get(e.groupID).updateGroup(e),ct({group:this.groupMap.get(e.groupID)}))).catch(e=>(s.setError(e).end(),lt.l(t+" failed. error:",e),Jt(e)))}_filterProfanity(e,t){const s=this.get(l);if(!s)return!0;var{isAllowedToSend:o,modifiedText:r}=s.filterText(t[e],I);return!0===o&&(t[e]=r,!0)}joinGroup(t){const{groupID:s,type:o}=t,r=this._n+".joinGroup";if(o===pe)return Jt({code:_t});if(this.deleteUnjoinedAVChatRoom(s),this.hasLocalGroup(s)){if(!this.isLoggedIn())return Kt({status:be});const o=new ts("applyJoinGroup");return this.getGroupProfile({groupID:s}).then(()=>(o.setMessage(`groupID:${s} joinedStatus:`+be).end(),Kt({status:be}))).catch(e=>(o.setMessage(`groupID:${s} unjoined`).end(),lt.w(r+` ${s} was unjoined, now join!`),this.groupMap.delete(s),this.applyJoinGroup(t)))}return lt.l(r+" groupID:"+s),this.isLoggedIn()?this.applyJoinGroup(t):this._AVChatRoomHandler.joinWithoutAuth(t)}applyJoinGroup(e){const a=this._n+".applyJoinGroup",{groupID:u,applyMessage:t}=e;if(!Ue(t)&&!1===this._filterProfanity("applyMessage",e))return Jt({code:Nt});const p=new ts("applyJoinGroup"),s={...e},l=this.canIUse(M.AV_HISTORY_MSG);return l&&(s.historyMessageFlag=1),this.get(o).deleteTopicRoamingMessageInfo(u),this.req({P:us,data:s}).then(({data:{joinedStatus:e,longPollingKey:t,startSeq:s,avChatRoomFlag:o,avChatRoomKey:r,messageList:i}})=>{var n=`groupID:${u} joinedStatus:${e} longPollingKey:${t} startSeq:${s} avChatRoomFlag:${o} canGetAVChatRoomHistoryMsg:${l}, historyMsgCount:`+(Ue(i)?0:i.length);switch(p.setMessage(n).end(),lt.l(a+" ok. "+n),e){case Re:return ct({status:Re});case Pe:return this.getGroupProfile({groupID:u}).then(({data:{group:e}})=>this._handleJoinResult({group:e,avChatRoomFlag:o,longPollingKey:t,startSeq:s,avChatRoomKey:r,messageList:i})).catch(e=>{if(10010!==e.code&&10007!==e.code)return lt.e(a+" failed. error:",e),Jt(e);{this._silentlyGetGroupProfile(e.code,u);const a=new Ro({groupID:u});return this.updateGroupMap([a]),this._handleJoinResult({group:a,avChatRoomFlag:o,longPollingKey:t,startSeq:s,avChatRoomKey:r,messageList:i})}});default:{const e=new ht({code:Gt});return lt.e(a+" failed. error:",e),Jt(e)}}}).catch(e=>(p.setMessage("groupID:"+u).setError(e).end(),lt.e(a+" failed. error:",e),Jt(e)))}_handleJoinResult(e){const{group:t,avChatRoomFlag:s,longPollingKey:r,startSeq:i,avChatRoomKey:n,messageList:a}=e,u=t["groupID"];if(1!==s)return this.emitGroupListUpdate(!0,!1),ct({status:Pe,group:t});{let e;return this.get(o).setCompleted(""+ne+u),this._groupAttributesHandler.initGroupAttributesCache({groupID:u,avChatRoomKey:n}),this._groupCountersHandler.initGroupCountersCache({groupID:u,avChatRoomKey:n}),(e=He(r)?this._AVChatRoomHandler.handleJoinResult({group:t}):this._AVChatRoomHandler.startRunLoop({group:t,longPollingKey:r,startSeq:i})).then(()=>{this._onAVChatRoomHistoryMessage(a,u)}),e}}quitGroup(e){const t=this._n+".quitGroup",s="groupID:"+e,o=(lt.l(t+" "+s),this.checkJoinedAVChatRoomByID(e));if(!o&&!this.hasLocalGroup(e))return Jt({code:yt});if(o&&!this.isLoggedIn())return lt.l(t+" anonymously ok. "+s),this.deleteLocalGroupAndConversation(e),this._AVChatRoomHandler.reset(e),Kt({groupID:e});const r=new ts("quitGroup");return r.setMessage(s),this.req({P:ls,data:{groupID:e}}).then(()=>(r.end(),lt.l(t+" ok"),this.deleteLocalGroupAndConversation(e),o&&this._AVChatRoomHandler.reset(e),this._groupAttributesHandler.deleteLocalGroupAttributes(e),ct({groupID:e}))).catch(e=>(r.setError(e).end(),lt.e(t+" failed. error:",e),Jt(e)))}searchGroupByID(e){const t=this._n+".searchGroupByID",s={groupIDList:[e]},o=new ts("searchGroupByID");return o.setMessage("groupID:"+e),lt.l(t+" groupID:"+e),this.req({P:cs,data:s}).then(({data:{groupProfile:e}})=>{if(0!==e[0].errorCode)throw new ht({code:e[0].errorCode,message:e[0].errorInfo});return o.end(),lt.l(t+" ok"),ct({group:new Ro(e[0])})}).catch(e=>(o.setError(e).end(),lt.w(t+" failed. error:",e),Jt(e)))}changeGroupOwner(o){const r=this._n+".changeGroupOwner";if(this.hasLocalGroup(o.groupID)&&this.getLocalGroupProfile(o.groupID).type===he)return Jt({code:It});if(o.newOwnerID===this.getMyUserID())return Jt({code:Dt});const i=new ts("changeGroupOwner");return i.setMessage(`groupID:${o.groupID} newOwnerID:`+o.newOwnerID),lt.l(r+" groupID:"+o.groupID),this.req({P:hs,data:o}).then(()=>{i.end(),lt.l(r+" ok");var{groupID:e,newOwnerID:t}=o;this.groupMap.get(e).ownerID=t;const s=this._groupMemberHandler.getLocalGroupMemberList(e);if(s instanceof Map){const o=s.get(this.getMyUserID()),r=(He(o)||(o.updateRole("Member"),this.groupMap.get(e).selfInfo.role="Member"),s.get(t));He(r)||r.updateRole("Owner")}return this.emitGroupListUpdate(!0,!1),ct({group:this.groupMap.get(e)})}).catch(e=>(i.setError(e).end(),lt.e(r+" failed. error:",e),Jt(e)))}getGroupApplicationList(){return this._groupSystemNoticeHandler.getGroupApplicationList()}handleGroupApplication(e){const t=this._n+".handleGroupApplication",{handleAction:l,handleMessage:h,message:s,application:o}=e;let r,i,n,a,u,g=(s?(r=s.payload.operatorID,i=s.payload.groupProfile.groupID,n=s.payload.authentication,a=s.payload.messageKey):o&&(r=o.applicant,i=o.groupID,n=o.authentication,a=o.messageKey),gs);o&&2===o.applicationType&&(g=ms,u=o.userID);const p=new ts("handleGroupApplication");return p.setMessage("groupID:"+i),lt.l(t+" groupID:"+i),this.req({P:g,data:{handleAction:l,handleMessage:h,applicant:r,invitee:u,groupID:i,authentication:n,messageKey:a}}).then(()=>(p.end(),lt.l(t+" ok"),s&&this._groupSystemNoticeHandler.deleteGroupSystemNotice({messageList:[e.message]}),ct({group:this.getLocalGroupProfile(i)}))).catch(e=>(p.setError(e).end(),lt.e(t+" failed. error",e),Jt(e)))}handleGroupInvitation(e){const t=this._n+".handleGroupInvitation",{groupProfile:{groupID:s},authentication:o,messageKey:r,operatorID:i}=e.message.payload,n=e["handleAction"],a=new ts("handleGroupInvitation");return a.setMessage(`groupID:${s} inviter:${i} handleAction:`+n),lt.l(t+` groupID:${s} inviter:${i} handleAction:`+n),this.req({P:ds,data:{...e,inviter:i,groupID:s,authentication:o,messageKey:r}}).then(()=>(a.end(),lt.l(t+" ok"),this._groupSystemNoticeHandler.deleteGroupSystemNotice({messageList:[e.message]}),ct({group:this.getLocalGroupProfile(s)}))).catch(e=>(a.setError(e).end(),lt.e(t+" failed. error",e),Jt(e)))}getGroupOnlineMemberCount(t){const s=this._n+".getGroupOnlineMemberCount",e=this._AVChatRoomHandler.checkJoinedAVChatRoomByID(t),o=this.hasLocalGroup(t);if(lt.l(s+` groupID:${t} isAVChatRoom:${e} has:`+o),e)return this._AVChatRoomHandler.getGroupOnlineMemberCount(t);if(!o)return Kt({memberCount:0});var r=Date.now();if(this._onlineMemberCountMap.has(t)){const s=this._onlineMemberCountMap.get(t);if(r-s.lastReqTime<=6e4)return Kt({memberCount:s.memberCount});s.lastReqTime=r}return this.requestOnlineCount(t).then(e=>{var{memberCount:e=0}=e.data;return this._onlineMemberCountMap.set(t,{lastReqTime:Date.now(),memberCount:e}),lt.l(s+` ok. groupID:${t} memberCount:`+e),Kt({memberCount:e})}).catch(e=>(lt.w(s+" failed. error:",e),Promise.reject(e)))}requestOnlineCount(e){return this.req({P:Ts,data:{groupID:e}})}hasLocalGroup(e){return this.groupMap.has(e)}deleteLocalGroupAndConversation(e){const t=this.checkJoinedAVChatRoomByID(e),r=(lt.l(this._n+`.deleteLocalGroupAndConversation groupID:${e} isJoinedAVChatRoom:`+t),this.get(o)),i=""+ne+e;if(t&&r.deleteLocalConv(i),et({groupID:e})){const t=this.getLocalGroupProfile(e);t&&!0===t.isSupportTopic&&this.get(s).deleteTopicListInCommunity(e)}r.clearUnreadCount(i),this._deleteLocalGroup(e),this._onlineMemberCountMap.delete(e),this.emitGroupListUpdate(!0,!1)}_deleteLocalGroup(e){this.groupMap.delete(e),this._groupMemberHandler.deleteGroupMemberList(e)}sendMessage(e,t){if(Ve(e._receiverList)&&0<e._receiverList.length&&!this.canIUse(M.MSG_TO_SPECIFIED_GRP_MBR))return this.noUse("Targeted Group Message");e=this.createGroupMessagePack(e,t);return this.req(e)}createGroupMessagePack(e,t){let s=null,o=(t&&t.offlinePushInfo&&(s=t.offlinePushInfo),"");Fe(e.cloudCustomData)&&0<e.cloudCustomData.length&&(o=e.cloudCustomData);const r=[];if(xe(t)&&xe(t.messageControlInfo)){const{excludedFromUnreadCount:e,excludedFromLastMessage:s,excludedFromContentModeration:o}=t.messageControlInfo;!0===e&&r.push("NoUnread"),!0===s&&r.push("NoLastMsg"),!0===o&&r.push("NoMsgCheck")}let i=void 0;Ve(e._receiverList)&&0<e._receiverList.length&&(i=e._receiverList,50<e._receiverList.length&&(i=e._receiverList.slice(0,50),this.warn("ReceiverListLimit")));const n=this.isOnlineMessage(e,t)?1:0,a=e.getGroupAtInfoList(),u={fromAccount:this.getMyUserID(),groupID:e.to,msgBody:e.getElements(),cloudCustomData:o,random:e.random,priority:e.priority,clientSequence:e.clientSequence,groupAtInfo:e.type!==j||Ue(a)?void 0:a,onlineOnlyFlag:n,clientTime:e.clientTime,offlinePushInfo:Oo(s),messageControlInfo:0==n?r:void 0,needReadReceipt:!0!==e.needReadReceipt||this.isMessageFromOrToAVChatroom(e.to)?0:1,receiverList:i,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0,cmConfigID:e._cmConfigID};return st(e.to)&&(u.groupID=ot(e.to),u.topicID=e.to),{P:ss,tjgID:this.generateTjgID(e),data:u}}revokeMessage(e){const t={groupID:e.to,msgSeqList:[{msgSeq:e.sequence}]};return st(e.to)&&(t.groupID=ot(e.to),t.topicID=e.to),this.req({P:_s,data:t})}deleteMessage(e){var{to:e,keyList:t}=e;lt.l(this._n+`.deleteMessage groupID:${e} count:`+t.length);const s={groupID:e,deleter:this.getMyUserID(),keyList:t};return st(e)&&(s.groupID=ot(e),s.topicID=e),this.req({P:As,data:s})}modifyRemoteMessage(e){var{to:e,sequence:t,payload:s,type:o,version:r=0,cloudCustomData:i}=e;let n=e,a=void 0,u=(st(e)&&(n=ot(e),a=e),void 0);return(e=o)!==j&&e!==Z&&e!==X&&e!==W||(u=[]).push({type:o,content:s}),this.req({P:vs,data:{groupID:n,topicID:a,sequence:t,version:r,elements:u,cloudCustomData:i}})}getRoamingMessage(e){const u=this._n+".getRoamingMessage";let{conversationID:p,groupID:l,sequence:t}=e;const h=new ts("getRoamingMessage");let g=0,c=void 0;return st(l)&&(l=ot(c=l)),this._computeLastSequence({groupID:l,topicID:c,sequence:t}).then(e=>(g=e,lt.l(u+` groupID:${l} startSequence:`+g),this.req({P:Ms,data:{groupID:l,count:21,sequence:g,topicID:c}}))).then(e=>{var{messageList:t,complete:s,invisibleSequenceList:r=[]}=e.data;let{nextSequence:i=0}=e.data;He(t)?lt.l(u+` ok. complete:${s} nextSequence:${i} but messageList is undefined!`):lt.l(u+` ok. complete:${s} nextSequence:${i} count:`+t.length),h.setMessage(`groupID:${l} topicID:${c} startSequence:${g} complete:${s} nextSequence:`+i).end();const n=this.get(o);let a=[];return Ue(t)?1<=i&&n.updateRoamingMsgSeq(p,i):(n.updateRoamingMsgSeq(p,i),a=n.onRoamingMessage(t,p),n.updateIsRead(p),n.patchConvLastMessage(p)),(2===s||i<1)&&(n.setCompleted(p),i=""),lt.l(u+` nextReqID:${i} storedMsgCount:${a.length} invisibleSeqCount:`+r.length),{nextReqID:i+"",storedMessageList:a}}).catch(e=>(h.setError(e).setMessage(`groupID:${l} topicID:${c} startSequence:`+g).end(),lt.w(u+" failed. error:",e),Jt(e)))}_getGroupIDOfMessage(e){return e.conversationID.replace(ne,"")}getReadReceiptList(s){const o=this._n+".getReadReceiptList",e=this._getGroupIDOfMessage(s[0]),t=this.getMyUserID(),r=s.filter(e=>e.from===t&&!0===e.needReadReceipt).map(e=>({sequence:e.sequence}));if(lt.l(o+` groupID:${e} sequenceList:`+JSON.stringify(r)),0===r.length)return Kt({messageList:s});const i=new ts("getReadReceiptList");return i.setMessage("groupID:"+e),this.req({P:Is,data:{groupID:e,sequenceList:r}}).then(e=>{i.end(),lt.l(o+" ok");const t=e.data["readReceiptList"];return Ve(t)&&t.forEach(t=>{s.forEach(e=>{0===t.code&&t.sequence===e.sequence&&(e.readReceiptInfo.readCount=t.readCount,e.readReceiptInfo.unreadCount=t.unreadCount)})}),ct({messageList:s})}).catch(e=>(i.setError(e).end(),lt.w(o+" failed. error:",e),Jt(e)))}sendReadReceipt(e){const t=this._n+".sendReadReceipt",s=this._getGroupIDOfMessage(e[0]),o=new ts("sendReadReceipt"),r=(o.setMessage("groupID:"+s),this.getMyUserID()),i=e.filter(e=>e.from!==r&&!0===e.needReadReceipt).map(e=>({sequence:e.sequence}));return 0===i.length?Jt({code:mt}):(lt.l(t+". sequenceList:"+JSON.stringify(i)),this.req({P:Ds,data:{groupID:s,sequenceList:i}}).then(e=>(o.end(),lt.l(t+" ok"),ct())).catch(e=>(o.setError(e).end(),lt.w(t+" failed. error:",e),Jt(e))))}getReadReceiptDetail(l){const{message:e,filter:t,cursor:s,count:o}=l,r=this._getGroupIDOfMessage(e),i=e.ID,h=e.sequence,n=this._n+".getReadReceiptDetail",g=this._receiptDetailCompleteMap.get(i)||!1,a=0!==t&&1!==t?0:t,c=Fe(s)?s:"",m=!Oe(o)||o<=0||100<=o?100:o,d=`groupID:${r} sequence:${h} cursor:${c} filter:${a} completeFlag:`+g,u=(lt.l(n+" "+d),{cursor:"",isCompleted:!1,messageID:i,unreadUserIDList:[],readUserIDList:[]}),p=new ts("getReadReceiptDetail");return p.setMessage(d),this.req({P:Ls,data:{groupID:r,sequence:h,flag:a,cursor:c,count:m}}).then(e=>{p.end();const{cursor:t,isCompleted:s,unreadUserIDList:o,readUserIDList:r}=e.data;return u.cursor=t,1===s&&(u.isCompleted=!0,this._receiptDetailCompleteMap.set(i,!0)),0===a?u.readUserIDList=r.map(e=>e.userID):1===a&&(u.unreadUserIDList=o.map(e=>e.userID)),lt.l(n+" ok"),ct(u)}).catch(e=>(p.setError(e).end(),lt.w(n+" failed. error:",e),Jt(e)))}getRoamingMessagesHopping(l){const h=this._n+".getRoamingMessagesHopping";let{groupID:t,count:s,sequence:g,direction:c}=l,r=void 0;return He(g)&&1===c?Kt({messageList:[],isCompleted:!0,nextMessageSeq:""}):(st(t)&&(t=ot(r=t)),this._computeReqSeqHopping({groupID:t,topicID:r,sequence:g}).then(e=>{He(g)||1!==c||(e=g+s-1);const u=`${r?"topicID:"+r:"groupID:"+t} sequence:${g} reqSeq:${e} direction:`+c,p=(lt.l(h+" "+u),new ts("getRoamingMessagesHopping"));return this.req({P:Ms,data:{groupID:t,topicID:r,count:s,sequence:e}}).then(e=>{var{messageList:e,complete:t}=e.data,s=`complete:${t} count:`+(e?e.length:0);if(p.setMessage(u+" "+s).end(),lt.l(h+" ok. "+s),2===t||Ue(e)){const l=this._computeResult();return ct(l)}const r=""+ne+l.groupID,i=this.get(o),n=i.onRoamingMessage(e,r,!1),a=this._computeResult({direction:c,sequence:g,remoteMessageList:e,processedMessageList:n});return i.storeHoppingMessageList(a.messageList),ct(a)}).catch(e=>(p.setError(e).setMessage(`groupID:${t} sequence:${g} count:`+s).end(),lt.w(h+" failed. error:",e),Jt(e)))}))}_computeReqSeqHopping(e){const{groupID:s,topicID:t,sequence:o}=e;return 0<o?Promise.resolve(o):He(t)?this.getGroupProfileAdvance({groupIDList:[s],responseFilter:{groupBaseInfoFilter:["NextMsgSeq"]}}).then(({data:{successGroupList:e}})=>{let t=0;return Ue(e)||(t=e[0].nextMessageSeq-1),lt.l(`${this._n}._computeReqSeqHopping groupID:${s} lastSequence:${t} from remote`),t}).catch(e=>Jt(e)):Promise.resolve(0)}_computeResult(e){const t={messageList:[],isCompleted:!1,nextMessageSeq:""};if(He(e))return t.isCompleted=!0,t;const{direction:s,sequence:o,remoteMessageList:r=[],processedMessageList:i=[]}=e,n=r.length;return 1===s?(t.nextMessageSeq=r[0].sequence+1,i.forEach(e=>{e.sequence>=o&&t.messageList.push(e)}),0===t.messageList.length&&r[0].sequence<o&&(t.isCompleted=!0,t.nextMessageSeq="")):(t.nextMessageSeq=r[n-1].sequence-1,t.messageList=[...i],0===t.nextMessageSeq&&(t.isCompleted=!0,t.nextMessageSeq="")),t}setMessageRead({conversationID:r,lastMessageSeq:i}){const n=this._n+".setMessageRead",e=`convID:${r} lastMessageSeq:`+i,a=(lt.l(n+" "+e),Oe(i)||this.warn("DoNotModifyLastSeq"),new ts("setMessageRead"));a.setMessage(e);let u=r.replace(ne,""),p=void 0;return st(u)&&(u=ot(p=u)),this.req({P:fs,data:{groupID:u,topicID:p,messageReadSeq:i}}).then(()=>{a.end(),lt.l(n+" ok");const e=this.get(o);e.updateIsReadAfterReadReport({conversationID:r,lastMessageSeq:i});let t=!0;if(!He(p)){t=!1;const r=this.get(s).getLocalTopic(u,p);r&&r.updateSelfInfo({readedSequence:i})}return e.updateUnreadCount(r,t),ct()}).catch(e=>(a.setError(e).end(),lt.l(n+" failed. error:",e),Jt(e)))}_computeLastSequence(e){var{groupID:e,topicID:t,sequence:s}=e;return 0<s?Promise.resolve(s):He(t)?this.getGroupLastSequence(e):Promise.resolve(0)}getGroupLastSequence(e){const t=this._n+".getGroupLastSequence",s=new ts("getGroupLastSequence");let r=0,i="";const n="groupID:"+e;if(this.hasLocalGroup(e)){const o=this.getLocalGroupProfile(e),a=o.lastMessage;if(0<a.lastSequence&&!1===a.onlineOnlyFlag)return r=a.lastSequence,i=n+`, ${r} from group.lastMessage.lastSequence`,lt.l(t+" "+i),s.setMessage(i).end(),Promise.resolve(r);if(1<o.nextMessageSeq)return r=o.nextMessageSeq-1,i=n+`, ${r} from group.nextMessageSeq`,lt.l(t+" "+i),s.setMessage(i).end(),Promise.resolve(r)}const a=this.get(o).getLocalConversation("GROUP"+e);return a&&a.lastMessage.lastSequence&&!1===a.lastMessage.onlineOnlyFlag?(r=a.lastMessage.lastSequence,i=n+`, ${r} from conversation.lastMessage.lastSequence`,lt.l(t+" "+i),s.setMessage(i).end(),Promise.resolve(r)):this.getGroupProfileAdvance({groupIDList:[e],responseFilter:{groupBaseInfoFilter:["NextMsgSeq"]}}).then(({data:{successGroupList:e}})=>(Ue(e)?lt.w(t+` ${n}, empty successGroupList`):(r=e[0].nextMessageSeq-1,i=n+`, ${r} from remote`,lt.l(t+" "+i)),s.setMessage(i).end(),r)).catch(e=>(s.setError(e).setMessage(n).end(),lt.w(t+" failed. error:",e),Jt(e)))}isMessageFromOrToAVChatroom(e){return this._AVChatRoomHandler.checkJoinedAVChatRoomByID(e)}hasJoinedAVChatRoom(){return this._AVChatRoomHandler.hasJoinedAVChatRoom()}getJoinedAVChatRoom(){return this._AVChatRoomHandler.getJoinedAVChatRoom()}getGroupRemoteLastSeq(e){e=this.getLocalGroupProfile(e);return e?e.nextMessageSeq-1:1}isOnlineMessage(e,t){return!(!this._canIUseOnlineOnlyFlag(e)||!t||!0!==t.onlineUserOnly)}_canIUseOnlineOnlyFlag(e){const t=this.getJoinedAVChatRoom();return!t||!t.includes(e.to)||e.conversationType!==ne}_onAVChatRoomHistoryMessage(e,t){if(!Ue(e)){lt.l(this._n+`._onAVChatRoomHistoryMessage groupID:${t} count:`+e.length);const s=[];e.forEach(e=>{s.push({...e,isHistoryMessage:1})}),this.onAVChatRoomMessage(s,t)}}onAVChatRoomMessage(e,t=""){this._AVChatRoomHandler.onMessage(e,t)}onAVChatRoomMemberBanned(e){this._AVChatRoomHandler.onAVChatRoomMemberBanned(e)}getGroupSimplifiedInfo(t){const s=new ts("getGroupSimplifiedInfo"),e={groupIDList:[t],responseFilter:{groupBaseInfoFilter:["Type","Name"]}};return this.getGroupProfileAdvance(e).then(({data:{successGroupList:e}})=>(s.setMessage(`groupID:${t} type:`+e[0].type).end(),e[0])).catch(e=>{s.setError(e).setMessage("groupID:"+t).end()})}setUnjoinedAVChatRoom(e){this._unjoinedAVChatRoomList.set(e,1)}deleteUnjoinedAVChatRoom(e){this._unjoinedAVChatRoomList.has(e)&&this._unjoinedAVChatRoomList.delete(e)}isUnjoinedAVChatRoom(e){return this._unjoinedAVChatRoomList.has(e)}isGroupAttributesUpdatedNotice(e){return this._groupAttributesHandler.isGroupAttributesUpdatedNotice(e)}updateLocalMainSequenceOnReconnected(){this._groupAttributesHandler.updateLocalMainSequenceOnReconnected()}initGroupAttributes(e){return this._groupAttributesHandler.initGroupAttributes(e)}setGroupAttributes(e){return this._groupAttributesHandler.setGroupAttributes(e)}deleteGroupAttributes(e){return this._groupAttributesHandler.deleteGroupAttributes(e)}getGroupAttributes(e){return this._groupAttributesHandler.getGroupAttributes(e)}isMessageFromTopic(e,t){return 2===e&&!Ue(t)}isMessageFromCommunityOfTopic(e,t){return 2===e&&Ue(t)}getMessageExtensions(e,t){return lt.l(this._n+".getMessageExtensions startSequence:"+t),this.req({P:Us,data:{groupID:e.to,messageSequence:e.sequence,startSequence:t}})}modifyMsgExts(e,t,s=1){return lt.l(this._n+".modifyMsgExts operateType:"+s),this.req({P:ws,data:{groupID:e.to,messageSequence:e.sequence,extensionList:t,operateType:s}})}_genNotifyReqList(s){const o=[];for(let e=0,t=s.length;e<t;e++){var r=s[e],i=this.getLocalGroupProfile(r)["type"],n=this._getGroupLastRevokedTime(r),a=1e3*Ae(),i={notifyType:1,limit:20,type:et({type:i,groupID:r})?ge:void 0,groupID:r,beginTime:n,endTime:a};o.push(i)}return o}getGroupNotify(e){const s=this._n+".getGroupNotify",t=e.filter(e=>{var{type:t,isSupportTopic:s}=this.getLocalGroupProfile(e);return this.hasLocalGroup(e)&&!Ze(t)&&!s});let o="filteredGroupIDList.length:"+t.length;t.length<=10&&(o="filteredGroupIDList:"+JSON.stringify(t)),lt.l(s+" "+o),0!==t.length&&this.req({P:Ns,data:{notifyReqList:this._genNotifyReqList(e)}}).then(o=>{const e=o.data["notifyRspList"],r=[];if(Ve(e)){const o={dataList:[]};e.forEach(e=>{var{nextRevokedTime:t,groupID:s}=e;o.dataList.push({elements:{revokedInfos:this._genRevokedInfos(e)}}),0!==t?(this._setGroupLastRevokedTime(s,t),r.push(s)):this._setGroupLastRevokedTime(s,1e3*Ae())}),this.onMsgRevoked(o)}0<r.length&&this.getGroupNotify(r);let t="nextGroupIDList.length:"+r.length;r.length<=10&&(t="nextGroupIDList:"+JSON.stringify(r)),lt.l(s+" "+t)}).catch(e=>{lt.e(s+" failed. error:",e)})}_genRevokedInfos(e){const{notifyList:t,groupID:s}=e,o=[];return Ve(t)&&t.forEach(e=>{o.push({groupID:s,sequence:e.sequence,random:e.random,revokerInfo:{...e.revokerInfo}})}),o}_getGroupLastRevokedTime(e){return this.hasLocalGroup(e)?this.getLocalGroupProfile(e)._lastRevokedTime:0}_setGroupLastRevokedTime(e,t){this.hasLocalGroup(e)&&(this.getLocalGroupProfile(e)._lastRevokedTime=t)}isGroupCountersNotice(e){return this._groupCountersHandler.isGroupCountersNotice(e)}setGroupCounters(e){return this._groupCountersHandler.setGroupCounters(e)}increaseGroupCounter(e){return this._groupCountersHandler.increaseGroupCounter(e)}decreaseGroupCounter(e){return this._groupCountersHandler.decreaseGroupCounter(e)}getGroupCounters(e){return this._groupCountersHandler.getGroupCounters(e)}getGroupMemberHandler(){return this._groupMemberHandler}getGroupMemberList(e){return this._groupMemberHandler.getGroupMemberList(e)}getGroupMemberProfile(e){return this._groupMemberHandler.getGroupMemberProfile(e)}addGroupMember(e){return this._groupMemberHandler.addGroupMember(e)}deleteGroupMember(e){return this._groupMemberHandler.deleteGroupMember(e)}setGroupMemberMuteTime(e){return this._groupMemberHandler.setGroupMemberMuteTime(e)}setGroupMemberRole(e){return this._groupMemberHandler.setGroupMemberRole(e)}setGroupMemberNameCard(e){return this._groupMemberHandler.setGroupMemberNameCard(e)}setGroupMemberCustomField(e){return this._groupMemberHandler.setGroupMemberCustomField(e)}markGroupMemberList(e){return this._groupMemberHandler.markGroupMemberList(e)}modifyGroupMemberInfo(e){return this._groupMemberHandler.modifyGroupMemberInfo(e)}restartPolling(){this._AVChatRoomHandler.restartPolling()}getPollingTimerID(e){if(!e)return-1;var t=this.getLocalGroupProfile(e);return t&&Ze(t.type)?this._AVChatRoomHandler.getPollingTimerID(e):-1}_canIUseJoinOption(e){return e===le||et({type:e})}_silentlyGetGroupProfile(e,t){var s=setTimeout(this.getGroupProfile.bind(this,{groupID:t}),3e3);this._timeoutIDs.push(s),lt.l(this._n+`._silentlyGetGroupProfile errorCode:${e} groupID:${t} timeoutIDs:`+this._timeoutIDs)}_clearTimeoutIDs(){this._timeoutIDs.forEach(e=>{clearTimeout(e)}),this._timeoutIDs=[]}startMessageLongPolling(e){var{groupID:e,longPollingKey:t,longPollingSequence:s=1}=e,o=this.get(r).isUnlimitedAVChatRoom(),i=(this._AVChatRoomHandler.hasPollingInstance(e)&&this.stopMessageLongPolling({groupID:e}),this._AVChatRoomHandler.getJoinedLiveList()),o=(!o&&0<i.length&&this.stopMessageLongPolling({groupID:i[0]}),new Ro({groupID:e,type:de}));return lt.l(this._n+`.startMessageLongPolling groupID:${e} longPollingKey:${t} longPollingSequence:`+s),this._AVChatRoomHandler.startRunLoop({group:o,longPollingKey:t,startSeq:s})}stopMessageLongPolling(e){const t=e["groupID"],s=this.get(o);return this._AVChatRoomHandler.reset(t),this._deleteLocalGroup(t),s.deleteLocalConv(""+ne+t),lt.l(this._n+".stopMessageLongPolling ok, groupID:"+t),Kt({groupID:t})}reset(){this.groupMap.clear(),this._unjoinedAVChatRoomList.clear(),this._receiptDetailCompleteMap.clear(),this._onlineMemberCountMap.clear(),this._commonGroupHandler.reset(),this._groupSystemNoticeHandler.reset(),this._groupTipsHandler.reset(),this._groupAttributesHandler.reset(),this._groupCountersHandler.reset(),this._AVChatRoomHandler.reset(),this._groupMemberHandler.reset(),this._clearTimeoutIDs()}}export{Ho as default};